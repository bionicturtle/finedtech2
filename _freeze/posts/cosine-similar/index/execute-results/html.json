{
  "hash": "b5ac054ff0359f1b032715c912e8e4cf",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Cosine similarity\ndescription: TBD\nauthor: David Harper, CFA, FRM\ndate: 2024-04-04\ncategories: [code, analysis]\nexecute: \n  echo: true\n  warning: false\n---\n\n\nNotes on this routine\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(word2vec)\n\n# Define words for vector1 and vector2\nvector1_words <- c(\"snow\",\"sun\", \"happy\", \"freedom\", \"graduate\", \"olympics\", \"vacation\", \n                   \"school\", \"resolutions\", \"beach\", \"mountain\", \"cold\", \"snowboard\", \"easter\")\nvector2_words <- c(\"winter\", \"spring\", \"summer\", \"fall\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# path to the GloVe file\nglove_path <- \"glove.6B/glove.6B.50d.txt\"\n\n# Function to load GloVe vectors from a file using data.table's fread for efficiency\nread_glove <- function(file_path) {\n    # Define column types: first column as character, remaining as numeric\n    num_columns <- length(fread(file_path, nrows = 1, header = FALSE)) # Detect the number of columns\n    col_types <- c(\"character\", rep(\"numeric\", num_columns - 1))\n\n    # Load data using fread with specified column types for efficiency\n    embeddings <- fread(file_path, header = FALSE, quote = \"\", colClasses = col_types)\n    setnames(embeddings, old = names(embeddings), new = c(\"word\", paste0(\"V\", 1:(num_columns-1))))\n\n    # Convert to data.table (if not already one, although fread should return a data.table)\n    embeddings <- as.data.table(embeddings)\n\n    return(embeddings)\n}\n\n# Load the GloVe embeddings\nm_w2v <- read_glove(glove_path)\n\n# Function to get embeddings for given words, retaining as dataframes\nget_embeddings <- function(model, words) {\n    setkey(model, word)\n    embeddings <- model[J(words), .SD, .SDcols = -\"word\", nomatch = 0L]\n    return(as.data.frame(embeddings))\n}\n\n\n\n# Obtain the vector for the words as dataframes\nvector1_embeds <- get_embeddings(m_w2v, vector1_words)\nvector2_embeds <- get_embeddings(m_w2v, vector2_words)\n\nsave(vector1_embeds, vector2_embeds, file = \"embeddings.RData\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the saved data\nload(\"embeddings.RData\")\n\n# Convert dataframes to matrices by dropping the first column\nvector1_embeds_m <- as.matrix(vector1_embeds[, -1, drop = FALSE])\nvector2_embeds_m <- as.matrix(vector2_embeds[, -1, drop = FALSE])\n\n# Set row and column names for matrices\nrownames(vector1_embeds_m) <- vector1_words\nrownames(vector2_embeds_m) <- vector2_words\n\n# Manual cosine similarity function\n# cosine_similarity <- function(matrix1, matrix2) {\n#     # Compute cosine similarity between each row of matrix1 and each row of matrix2\n#     result <- matrix(0, nrow = nrow(matrix1), ncol = nrow(matrix2))\n#     for (i in 1:nrow(matrix1)) {\n#         for (j in 1:nrow(matrix2)) {\n#             result[i, j] <- sum(matrix1[i, ] * matrix2[j, ]) / (sqrt(sum(matrix1[i, ]^2)) * sqrt(sum(matrix2[j, ]^2)))\n#         }\n#     }\n#     dimnames(result) <- list(row.names(matrix1), row.names(matrix2))\n#     return(result)\n# }\n\ncosine_similarity <- function(matrix1, matrix2) {\n  norm_matrix1 <- sqrt(rowSums(matrix1^2))\n  norm_matrix2 <- sqrt(rowSums(matrix2^2))\n  result <- matrix1 %*% t(matrix2) / (norm_matrix1 %o% norm_matrix2)\n  dimnames(result) <- list(row.names(matrix1), row.names(matrix2))\n  return(result)\n}\n\n# Compute the similarity between the two collections of embeddings\nsimilarity_results <- word2vec_similarity(vector1_embeds_m, vector2_embeds_m, type = \"cosine\")\n\n# Manually compute cosine similarity\nmanual_similarity_results <- cosine_similarity(vector1_embeds_m, vector2_embeds_m)\n\n# Print the word2vec similarity results with row and column names\nprint(\"word2vec_similarity results:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"word2vec_similarity results:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(similarity_results)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                winter    spring    summer      fall\nsnow        0.74125017 0.6963912 0.6185827 0.5663821\nsun         0.44478379 0.5830609 0.4773879 0.5118248\nhappy       0.48504846 0.5028063 0.5609525 0.5506670\nfreedom     0.18136758 0.2254465 0.2702612 0.3755605\ngraduate    0.25377881 0.3788511 0.4521937 0.3111673\nolympics    0.66424604 0.4863632 0.6722972 0.4371825\nvacation    0.66606219 0.6043653 0.7153726 0.5044602\nschool      0.39208831 0.5613046 0.5794563 0.4539855\nresolutions 0.09477322 0.1713795 0.1198187 0.2054978\nbeach       0.50492486 0.5174625 0.5725889 0.3445451\nmountain    0.56929335 0.5649946 0.5214697 0.4198440\ncold        0.70956314 0.6887602 0.6809916 0.6406256\nsnowboard   0.31661765 0.1385683 0.2266248 0.0351622\neaster      0.55143247 0.6239188 0.5490755 0.4957569\n```\n\n\n:::\n\n```{.r .cell-code}\n# Print the manually calculated cosine similarity results\nprint(\"Manual cosine_similarity results:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Manual cosine_similarity results:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(manual_similarity_results)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                winter    spring    summer      fall\nsnow        0.74125017 0.6963912 0.6185827 0.5663821\nsun         0.44478379 0.5830609 0.4773879 0.5118248\nhappy       0.48504846 0.5028063 0.5609525 0.5506670\nfreedom     0.18136758 0.2254465 0.2702612 0.3755605\ngraduate    0.25377881 0.3788511 0.4521937 0.3111673\nolympics    0.66424604 0.4863632 0.6722972 0.4371825\nvacation    0.66606219 0.6043653 0.7153726 0.5044602\nschool      0.39208831 0.5613046 0.5794563 0.4539855\nresolutions 0.09477322 0.1713795 0.1198187 0.2054978\nbeach       0.50492486 0.5174625 0.5725889 0.3445451\nmountain    0.56929335 0.5649946 0.5214697 0.4198440\ncold        0.70956314 0.6887602 0.6809916 0.6406256\nsnowboard   0.31661765 0.1385683 0.2266248 0.0351622\neaster      0.55143247 0.6239188 0.5490755 0.4957569\n```\n\n\n:::\n:::\n\n\nheatmap\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nsimilarity_matrix <- similarity_results\n\n# Convert the matrix to a data frame for plotting\nsimilarity_df <- as.data.frame(as.table(similarity_matrix))\nnames(similarity_df) <- c(\"Word1\", \"Word2\", \"Similarity\")\n\n# Plot the heatmap\nggplot(similarity_df, aes(x = Word2, y = Word1, fill = Similarity)) +\n  geom_tile() +\n  scale_fill_gradient2(low = \"white\", high = \"darkgreen\", mid = \"lightgreen\", midpoint = 0.5, na.value = \"lightgrey\",\n                       limit = c(0.15, 0.85), space = \"Lab\", name=\"Cosine\\nSimilarity\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  labs(x = NULL, y = NULL, title = \"Cosine Similarity Heatmap\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}