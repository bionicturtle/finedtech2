<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Harper, CFA, FRM">
<meta name="dcterms.date" content="2023-11-26">
<meta name="description" content="Visualizing correlation and mapping CMLs">

<title>finedtech by David Harper, CFA, FRM - Applying my PPC data model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">finedtech by David Harper, CFA, FRM</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About David</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bionicturtle" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/davidharper2/" rel="" target=""><i class="bi bi-instagram" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Applying my PPC data model</h1>
                  <div>
        <div class="description">
          Visualizing correlation and mapping CMLs
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>David Harper, CFA, FRM </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 26, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Contents</p>
<ul>
<li>Define the potential portfolios (= sets of assets)</li>
<li>Retrieve returns for each periodicity; aka, frequency</li>
<li>Add analysis list-column: volatility, avg return, correlation matrix</li>
<li>Correlation
<ul>
<li>Single stocks are better diversifiers</li>
<li>Visualize correlation</li>
</ul></li>
<li>Simulation
<ul>
<li>Select the portfolio (set)</li>
<li>Bias the random weights</li>
<li>Setup the simulation; i.e., functions</li>
<li>Run the simulation</li>
</ul></li>
<li>Visualize
<ul>
<li>Add a second CML</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse); <span class="fu">library</span>(patchwork); <span class="fu">library</span> (ggcorrplot); <span class="fu">library</span>(gt)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyquant)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS) <span class="co"># write.matrix</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># library(dplyr); library(tidyr); library(purrr)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># library(ggplot)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="define-the-potential-portfolios-sets-of-assets" class="level2">
<h2 class="anchored" data-anchor-id="define-the-potential-portfolios-sets-of-assets">Define the potential portfolios (= sets of assets)</h2>
<p>The container in this approach is <strong>stock_sets</strong>, a dataframe we initialize (as our TOC) with three columns:</p>
<ul>
<li>set_id</li>
<li>description</li>
<li>symbols: a list of tickers</li>
</ul>
<p>Each row of the <strong>stock_sets</strong> dataframe hold an entire portfolio including these identifiers plus the returns (via <strong>nested_data</strong>), and the <strong>analysis</strong>. The latter two are added as <em>list-columns</em> which are versatile objects: list-items can include dataframes, vectors, and even other lists.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First row of stock_sets is (portfolio of) sector ETFs:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sector_11etf_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"XLK"</span>,  <span class="co"># Technology</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLV"</span>,  <span class="co"># Health Care</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLF"</span>,  <span class="co"># Financials</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLY"</span>,  <span class="co"># Consumer Discretionary</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLP"</span>,  <span class="co"># Consumer Staples</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLE"</span>,  <span class="co"># Energy</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLU"</span>,  <span class="co"># Utilities</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLI"</span>,  <span class="co"># Industrials</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLB"</span>,  <span class="co"># Materials</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLRE"</span>, <span class="co"># Real Estate</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"XLC"</span>) <span class="co"># Communication Services</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Second row of stock_sets is (portfolio of) style ETFs:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>size_style_etfs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"IWF"</span>,  <span class="co"># Large-Cap Growth</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWD"</span>,  <span class="co"># Large-Cap Value</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"SPY"</span>,  <span class="co"># Large-Cap Blend</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWP"</span>,  <span class="co"># Mid-Cap Growth</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWS"</span>,  <span class="co"># Mid-Cap Value</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"MDY"</span>,  <span class="co"># Mid-Cap Blend</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWO"</span>,  <span class="co"># Small-Cap Growth</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWN"</span>,  <span class="co"># Small-Cap Value</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"IWM"</span>)  <span class="co"># Small-Cap Blend</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Third row is largest (by market cap) company in each sector:</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>large_mid_caps <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"large_mid_caps.csv"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>large_mid_caps <span class="ot">&lt;-</span> large_mid_caps <span class="sc">|&gt;</span> <span class="fu">rename_at</span>(<span class="st">'Market Cap'</span>, <span class="sc">~</span> <span class="st">'Capitalization'</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>large_mid_caps<span class="sc">$</span>Industry <span class="ot">&lt;-</span> <span class="fu">as_factor</span>(large_mid_caps<span class="sc">$</span>Industry)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>large_mid_caps<span class="sc">$</span>Sector <span class="ot">&lt;-</span> <span class="fu">as_factor</span>(large_mid_caps<span class="sc">$</span>Sector)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># select the largest (by Market Cap) in each Industry</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>top_in_sector <span class="ot">&lt;-</span> large_mid_caps <span class="sc">|&gt;</span> </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Sector) <span class="sc">|&gt;</span> </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(Capitalization)) <span class="sc">|&gt;</span> </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>remove_rows <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">15</span>, <span class="dv">17</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>top_in_sector <span class="ot">&lt;-</span> top_in_sector[<span class="sc">-</span>remove_rows,]</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the essential stock_sets dataframe</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>stock_sets <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">set_id =</span> <span class="fu">c</span>(<span class="st">"11_sectors"</span>,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>               <span class="st">"9_styles"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>               <span class="st">"13_top_in_sector"</span>),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">description =</span> <span class="fu">c</span>(<span class="st">"All 11 Sectors"</span>,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"All 9 Styles"</span>,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Top Market Cap in each of 13 Sectors"</span>), </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this is a list column, see https://adv-r.hadley.nz/vectors-chap.html#list-columns </span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">symbols =</span> <span class="fu">list</span>(sector_11etf_list, size_style_etfs, top_in_sector<span class="sc">$</span>Ticker)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>date_start <span class="ot">&lt;-</span> <span class="st">"2013-01-01"</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>date_end   <span class="ot">&lt;-</span> <span class="st">"2023-11-17"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="retrieve-returns-for-each-frequency-aka-periodicity" class="level2">
<h2 class="anchored" data-anchor-id="retrieve-returns-for-each-frequency-aka-periodicity">Retrieve returns for each frequency; aka, periodicity</h2>
<p>Each portfolio is a set of tickers/symbols. For <em>each</em> of the portfolio’s symbols (aka, tickers), the <strong>get_returns</strong> function retrieves log returns into three dataframes; one for each frequency:</p>
<ul>
<li>daily</li>
<li>weekly</li>
<li>monthly</li>
</ul>
<p>We will call the <strong>get_returns</strong> function via map (purrr is one of my favorite packagse!) to create a new list column called <strong>nested_data</strong>. Each row of nested_data <em>will contain a list</em> of three dataframes, one for each period. These dataframes will contain the log returns for each ticker in the set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This will add the nested_data list-column. For example, we</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># can use stock_sets$nested_data[[n]]$daily$daily.returns to</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve daily.returns for the nth portfolio</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>get_returns <span class="ot">&lt;-</span> <span class="cf">function</span>(symbols, start_date, end_date) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    mult_stocks <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(symbols, <span class="at">get =</span> <span class="st">"stock.prices"</span>, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">from =</span> start_date, <span class="at">to =</span> end_date)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    periods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"daily"</span>, <span class="st">"weekly"</span>, <span class="st">"monthly"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    returns_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(periods, <span class="cf">function</span>(period) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        mult_stocks <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tq_transmute</span>(<span class="at">select =</span> adjusted,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mutate_fun =</span> periodReturn, </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">period =</span> period, </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="st">"log"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(returns_list) <span class="ot">&lt;-</span> periods</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(returns_list)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Nest return data for each stock set</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>stock_sets <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nested_data =</span> <span class="fu">map</span>(symbols, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">~</span> <span class="fu">get_returns</span>(.x, date_start, date_end)))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stock_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  set_id           description                          symbols    nested_data 
  &lt;chr&gt;            &lt;chr&gt;                                &lt;list&gt;     &lt;list&gt;      
1 11_sectors       All 11 Sectors                       &lt;chr [11]&gt; &lt;named list&gt;
2 9_styles         All 9 Styles                         &lt;chr [9]&gt;  &lt;named list&gt;
3 13_top_in_sector Top Market Cap in each of 13 Sectors &lt;chr [13]&gt; &lt;named list&gt;</code></pre>
</div>
</div>
</section>
<section id="add-analysis-list-column-volatility-avg-return-correlation-matrix" class="level2">
<h2 class="anchored" data-anchor-id="add-analysis-list-column-volatility-avg-return-correlation-matrix">Add analysis list-column: volatility, avg return, correlation matrix</h2>
<p>For each portfolio (set of tickers) and periodicity, the <strong>analysis</strong> list column generates:</p>
<ul>
<li>vector of volatilities</li>
<li>vector of average returns</li>
<li>correlation matrix (diagonal is 1)</li>
<li>average correlation (as a <em>rough</em> measure of diversification)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For example, we can use stock_sets$analysis[[1]]$monthly$corr_matrix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to retrieve the correlation matrix for the nth portfolio</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>perform_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(data, frequency) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the column name for returns based on the frequency</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    returns_col <span class="ot">&lt;-</span> <span class="cf">switch</span>(frequency,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"daily"</span> <span class="ot">=</span> <span class="st">"daily.returns"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"weekly"</span> <span class="ot">=</span> <span class="st">"weekly.returns"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"monthly"</span> <span class="ot">=</span> <span class="st">"monthly.returns"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">stop</span>(<span class="st">"Invalid frequency"</span>))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate volatilities</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    volatilities <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">volatility =</span> <span class="fu">sd</span>(.data[[returns_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate average returns</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    avg_returns <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">avg_return =</span> <span class="fu">mean</span>(.data[[returns_col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to wide format for correlation matrix calculation</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    data_wide <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> symbol, <span class="at">values_from =</span> .data[[returns_col]])</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write files to verify (in Excel) the correlation matrix</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write.csv(data_wide, paste0("data_wide_", frequency, ".csv"), row.names = FALSE)</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the correlation matrix</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    corr_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(data_wide[ ,<span class="sc">-</span><span class="dv">1</span>], <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write.csv(as.data.frame(corr_matrix), paste0("corr_matrix_", frequency, ".csv"), row.names = TRUE) </span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate average correlation</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    avg_corr <span class="ot">&lt;-</span> <span class="fu">mean</span>(corr_matrix[<span class="fu">lower.tri</span>(corr_matrix)])</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">volatilities =</span> volatilities, </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_returns =</span> avg_returns, </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                <span class="at">corr_matrix =</span> corr_matrix, </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_corr =</span> avg_corr))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the perform_analysis function to the stock_sets</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>stock_sets <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">analysis =</span> <span class="fu">map</span>(nested_data, <span class="sc">~</span> {</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>            <span class="at">daily =</span> <span class="fu">perform_analysis</span>(.x<span class="sc">$</span>daily, <span class="st">"daily"</span>),</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>            <span class="at">weekly =</span> <span class="fu">perform_analysis</span>(.x<span class="sc">$</span>weekly, <span class="st">"weekly"</span>),</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            <span class="at">monthly =</span> <span class="fu">perform_analysis</span>(.x<span class="sc">$</span>monthly, <span class="st">"monthly"</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine data structure </span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stock_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  set_id           description                 symbols nested_data  analysis    
  &lt;chr&gt;            &lt;chr&gt;                       &lt;list&gt;  &lt;list&gt;       &lt;list&gt;      
1 11_sectors       All 11 Sectors              &lt;chr&gt;   &lt;named list&gt; &lt;named list&gt;
2 9_styles         All 9 Styles                &lt;chr&gt;   &lt;named list&gt; &lt;named list&gt;
3 13_top_in_sector Top Market Cap in each of … &lt;chr&gt;   &lt;named list&gt; &lt;named list&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(stock_sets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 3
Columns: 5
$ set_id      &lt;chr&gt; "11_sectors", "9_styles", "13_top_in_sector"
$ description &lt;chr&gt; "All 11 Sectors", "All 9 Styles", "Top Market Cap in each …
$ symbols     &lt;list&gt; &lt;"XLK", "XLV", "XLF", "XLY", "XLP", "XLE", "XLU", "XLI", "…
$ nested_data &lt;list&gt; [[&lt;grouped_df[28057 x 3]&gt;], [&lt;grouped_df[5819 x 3]&gt;], [&lt;g…
$ analysis    &lt;list&gt; [[[&lt;tbl_df[11 x 2]&gt;], [&lt;tbl_df[11 x 2]&gt;], &lt;&lt;matrix[11 x 1…</code></pre>
</div>
</div>
</section>
<section id="correlation" class="level2">
<h2 class="anchored" data-anchor-id="correlation">Correlation</h2>
<section id="average-average-correlation" class="level3">
<h3 class="anchored" data-anchor-id="average-average-correlation">Average average correlation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GPT4 basically wrote this entire chunk: I added it while writing substack</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare a dataframe for the average correlations</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>avg_corr_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Portfolio =</span> <span class="fu">character</span>(),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Frequency =</span> <span class="fu">character</span>(),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Average_Correlation =</span> <span class="fu">numeric</span>()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each portfolio and each frequency</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(stock_sets<span class="sc">$</span>analysis)) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    portfolio_id <span class="ot">&lt;-</span> stock_sets<span class="sc">$</span>set_id[i]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (freq <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"daily"</span>, <span class="st">"weekly"</span>, <span class="st">"monthly"</span>)) {</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        avg_corr <span class="ot">&lt;-</span> stock_sets<span class="sc">$</span>analysis[[i]][[freq]]<span class="sc">$</span>avg_corr</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        avg_corr_data <span class="ot">&lt;-</span> avg_corr_data <span class="sc">|&gt;</span> </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_row</span>(</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">Portfolio =</span> portfolio_id,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">Frequency =</span> freq,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">Average_Correlation =</span> avg_corr</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a wider table format</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>avg_corr_wide <span class="ot">&lt;-</span> avg_corr_data <span class="sc">|&gt;</span> </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> Frequency,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> Average_Correlation,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_prefix =</span> <span class="st">"Avg_Corr_"</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column for the overall average correlation</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>avg_corr_wide <span class="ot">&lt;-</span> avg_corr_wide <span class="sc">|&gt;</span> </span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Avg_Corr_Total =</span> <span class="fu">mean</span>(<span class="fu">c_across</span>(<span class="fu">starts_with</span>(<span class="st">"Avg_Corr_"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>avg_corr_wide <span class="sc">|&gt;</span> </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"Average Correlation per Frequency"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_label</span>(</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">Portfolio =</span> <span class="st">"Portfolio"</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">Avg_Corr_daily =</span> <span class="st">"Daily"</span>,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">Avg_Corr_weekly =</span> <span class="st">"Weekly"</span>,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">Avg_Corr_monthly =</span> <span class="st">"Monthly"</span>,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">Avg_Corr_Total =</span> <span class="st">"Avg Avg Corr"</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">decimals =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="uulavkairt" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#uulavkairt table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#uulavkairt thead, #uulavkairt tbody, #uulavkairt tfoot, #uulavkairt tr, #uulavkairt td, #uulavkairt th {
  border-style: none;
}

#uulavkairt p {
  margin: 0;
  padding: 0;
}

#uulavkairt .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#uulavkairt .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#uulavkairt .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#uulavkairt .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#uulavkairt .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uulavkairt .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uulavkairt .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uulavkairt .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#uulavkairt .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#uulavkairt .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#uulavkairt .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#uulavkairt .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#uulavkairt .gt_spanner_row {
  border-bottom-style: hidden;
}

#uulavkairt .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#uulavkairt .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#uulavkairt .gt_from_md > :first-child {
  margin-top: 0;
}

#uulavkairt .gt_from_md > :last-child {
  margin-bottom: 0;
}

#uulavkairt .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#uulavkairt .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#uulavkairt .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#uulavkairt .gt_row_group_first td {
  border-top-width: 2px;
}

#uulavkairt .gt_row_group_first th {
  border-top-width: 2px;
}

#uulavkairt .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uulavkairt .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#uulavkairt .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#uulavkairt .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uulavkairt .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uulavkairt .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#uulavkairt .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#uulavkairt .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#uulavkairt .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uulavkairt .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uulavkairt .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uulavkairt .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uulavkairt .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uulavkairt .gt_left {
  text-align: left;
}

#uulavkairt .gt_center {
  text-align: center;
}

#uulavkairt .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#uulavkairt .gt_font_normal {
  font-weight: normal;
}

#uulavkairt .gt_font_bold {
  font-weight: bold;
}

#uulavkairt .gt_font_italic {
  font-style: italic;
}

#uulavkairt .gt_super {
  font-size: 65%;
}

#uulavkairt .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#uulavkairt .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#uulavkairt .gt_indent_1 {
  text-indent: 5px;
}

#uulavkairt .gt_indent_2 {
  text-indent: 10px;
}

#uulavkairt .gt_indent_3 {
  text-indent: 15px;
}

#uulavkairt .gt_indent_4 {
  text-indent: 20px;
}

#uulavkairt .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_heading">
      <td colspan="5" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Average Correlation per Frequency</td>
    </tr>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Portfolio">Portfolio</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Daily">Daily</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Weekly">Weekly</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Monthly">Monthly</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Avg Avg Corr">Avg Avg Corr</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="Portfolio" class="gt_row gt_left">11_sectors</td>
<td headers="Avg_Corr_daily" class="gt_row gt_right">0.676</td>
<td headers="Avg_Corr_weekly" class="gt_row gt_right">0.682</td>
<td headers="Avg_Corr_monthly" class="gt_row gt_right">0.677</td>
<td headers="Avg_Corr_Total" class="gt_row gt_right">0.678</td></tr>
    <tr><td headers="Portfolio" class="gt_row gt_left">9_styles</td>
<td headers="Avg_Corr_daily" class="gt_row gt_right">0.899</td>
<td headers="Avg_Corr_weekly" class="gt_row gt_right">0.902</td>
<td headers="Avg_Corr_monthly" class="gt_row gt_right">0.899</td>
<td headers="Avg_Corr_Total" class="gt_row gt_right">0.900</td></tr>
    <tr><td headers="Portfolio" class="gt_row gt_left">13_top_in_sector</td>
<td headers="Avg_Corr_daily" class="gt_row gt_right">0.371</td>
<td headers="Avg_Corr_weekly" class="gt_row gt_right">0.344</td>
<td headers="Avg_Corr_monthly" class="gt_row gt_right">0.325</td>
<td headers="Avg_Corr_Total" class="gt_row gt_right">0.346</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</section>
<section id="single-stocks-are-better-diversifiers" class="level3">
<h3 class="anchored" data-anchor-id="single-stocks-are-better-diversifiers">Single stocks are better diversifiers</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>create_avg_corr_table <span class="ot">&lt;-</span> <span class="cf">function</span>(monthly_data, <span class="at">title =</span> <span class="st">"Data Analysis"</span>) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    corr_matrix <span class="ot">&lt;-</span> monthly_data<span class="sc">$</span>corr_matrix</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    symbols <span class="ot">&lt;-</span> <span class="fu">rownames</span>(corr_matrix)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average correlation for each stock excluding the stock itself</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    avg_correlations_per_stock <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(corr_matrix)), <span class="cf">function</span>(i) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        row_correlations <span class="ot">&lt;-</span> corr_matrix[i, ]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(row_correlations[<span class="sc">-</span>i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    avg_correlations_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">symbol =</span> symbols, </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">avg_correlation =</span> avg_correlations_per_stock)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    combined_data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(monthly_data<span class="sc">$</span>volatilities,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                               monthly_data<span class="sc">$</span>avg_returns, <span class="at">by =</span> <span class="st">"symbol"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(avg_correlations_df, <span class="at">by =</span> <span class="st">"symbol"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    gt_table <span class="ot">&lt;-</span> combined_data <span class="sc">|&gt;</span> </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tab_header</span>(<span class="at">title =</span> title) <span class="sc">|&gt;</span> </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cols_label</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">symbol =</span> <span class="st">"Symbol"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">volatility =</span> <span class="st">"Volatility"</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">avg_return =</span> <span class="st">"Avg Return"</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">avg_correlation =</span> <span class="st">"Correlation(*)"</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span> </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="dv">4</span>, <span class="at">decimals =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tab_footnote</span>(<span class="st">"(*) Pairwise average(ρ): matrix row/column average excluding diagonal"</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(gt_table)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>monthly_data <span class="ot">&lt;-</span> stock_sets<span class="sc">$</span>analysis[[<span class="dv">1</span>]]<span class="sc">$</span>monthly</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="fu">create_avg_corr_table</span>(monthly_data, <span class="st">"Sectors, Monthly Returns"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="mxvznzsnfs" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#mxvznzsnfs table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#mxvznzsnfs thead, #mxvznzsnfs tbody, #mxvznzsnfs tfoot, #mxvznzsnfs tr, #mxvznzsnfs td, #mxvznzsnfs th {
  border-style: none;
}

#mxvznzsnfs p {
  margin: 0;
  padding: 0;
}

#mxvznzsnfs .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#mxvznzsnfs .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#mxvznzsnfs .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#mxvznzsnfs .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#mxvznzsnfs .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mxvznzsnfs .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mxvznzsnfs .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mxvznzsnfs .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#mxvznzsnfs .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#mxvznzsnfs .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#mxvznzsnfs .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#mxvznzsnfs .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#mxvznzsnfs .gt_spanner_row {
  border-bottom-style: hidden;
}

#mxvznzsnfs .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#mxvznzsnfs .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#mxvznzsnfs .gt_from_md > :first-child {
  margin-top: 0;
}

#mxvznzsnfs .gt_from_md > :last-child {
  margin-bottom: 0;
}

#mxvznzsnfs .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#mxvznzsnfs .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#mxvznzsnfs .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#mxvznzsnfs .gt_row_group_first td {
  border-top-width: 2px;
}

#mxvznzsnfs .gt_row_group_first th {
  border-top-width: 2px;
}

#mxvznzsnfs .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mxvznzsnfs .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#mxvznzsnfs .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#mxvznzsnfs .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mxvznzsnfs .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mxvznzsnfs .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#mxvznzsnfs .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#mxvznzsnfs .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#mxvznzsnfs .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mxvznzsnfs .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mxvznzsnfs .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mxvznzsnfs .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mxvznzsnfs .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mxvznzsnfs .gt_left {
  text-align: left;
}

#mxvznzsnfs .gt_center {
  text-align: center;
}

#mxvznzsnfs .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#mxvznzsnfs .gt_font_normal {
  font-weight: normal;
}

#mxvznzsnfs .gt_font_bold {
  font-weight: bold;
}

#mxvznzsnfs .gt_font_italic {
  font-style: italic;
}

#mxvznzsnfs .gt_super {
  font-size: 65%;
}

#mxvznzsnfs .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#mxvznzsnfs .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#mxvznzsnfs .gt_indent_1 {
  text-indent: 5px;
}

#mxvznzsnfs .gt_indent_2 {
  text-indent: 10px;
}

#mxvznzsnfs .gt_indent_3 {
  text-indent: 15px;
}

#mxvznzsnfs .gt_indent_4 {
  text-indent: 20px;
}

#mxvznzsnfs .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_heading">
      <td colspan="4" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Sectors, Monthly Returns</td>
    </tr>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Symbol">Symbol</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Volatility">Volatility</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Avg Return">Avg Return</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Correlation(*)">Correlation(*)</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="symbol" class="gt_row gt_left">XLB</td>
<td headers="volatility" class="gt_row gt_right">5.30%</td>
<td headers="avg_return" class="gt_row gt_right">0.73%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.76</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLC</td>
<td headers="volatility" class="gt_row gt_right">6.09%</td>
<td headers="avg_return" class="gt_row gt_right">0.58%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.69</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLE</td>
<td headers="volatility" class="gt_row gt_right">8.35%</td>
<td headers="avg_return" class="gt_row gt_right">0.40%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.54</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLF</td>
<td headers="volatility" class="gt_row gt_right">5.44%</td>
<td headers="avg_return" class="gt_row gt_right">0.87%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.72</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLI</td>
<td headers="volatility" class="gt_row gt_right">5.12%</td>
<td headers="avg_return" class="gt_row gt_right">0.91%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.77</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLK</td>
<td headers="volatility" class="gt_row gt_right">5.17%</td>
<td headers="avg_return" class="gt_row gt_right">1.50%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.69</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLP</td>
<td headers="volatility" class="gt_row gt_right">3.64%</td>
<td headers="avg_return" class="gt_row gt_right">0.72%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.66</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLRE</td>
<td headers="volatility" class="gt_row gt_right">5.01%</td>
<td headers="avg_return" class="gt_row gt_right">0.46%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.71</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLU</td>
<td headers="volatility" class="gt_row gt_right">4.35%</td>
<td headers="avg_return" class="gt_row gt_right">0.70%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.55</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLV</td>
<td headers="volatility" class="gt_row gt_right">3.99%</td>
<td headers="avg_return" class="gt_row gt_right">1.01%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.66</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XLY</td>
<td headers="volatility" class="gt_row gt_right">5.42%</td>
<td headers="avg_return" class="gt_row gt_right">1.04%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.71</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="4"> (*) Pairwise average(ρ): matrix row/column average excluding diagonal</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>monthly_data <span class="ot">&lt;-</span> stock_sets<span class="sc">$</span>analysis[[<span class="dv">3</span>]]<span class="sc">$</span>monthly</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">create_avg_corr_table</span>(monthly_data, <span class="st">"Largest Stock in Sector, Monthly Returns"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="daidptzdvp" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#daidptzdvp table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#daidptzdvp thead, #daidptzdvp tbody, #daidptzdvp tfoot, #daidptzdvp tr, #daidptzdvp td, #daidptzdvp th {
  border-style: none;
}

#daidptzdvp p {
  margin: 0;
  padding: 0;
}

#daidptzdvp .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#daidptzdvp .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#daidptzdvp .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#daidptzdvp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#daidptzdvp .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#daidptzdvp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#daidptzdvp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#daidptzdvp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#daidptzdvp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#daidptzdvp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#daidptzdvp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#daidptzdvp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#daidptzdvp .gt_spanner_row {
  border-bottom-style: hidden;
}

#daidptzdvp .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#daidptzdvp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#daidptzdvp .gt_from_md > :first-child {
  margin-top: 0;
}

#daidptzdvp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#daidptzdvp .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#daidptzdvp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#daidptzdvp .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#daidptzdvp .gt_row_group_first td {
  border-top-width: 2px;
}

#daidptzdvp .gt_row_group_first th {
  border-top-width: 2px;
}

#daidptzdvp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#daidptzdvp .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#daidptzdvp .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#daidptzdvp .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#daidptzdvp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#daidptzdvp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#daidptzdvp .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#daidptzdvp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#daidptzdvp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#daidptzdvp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#daidptzdvp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#daidptzdvp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#daidptzdvp .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#daidptzdvp .gt_left {
  text-align: left;
}

#daidptzdvp .gt_center {
  text-align: center;
}

#daidptzdvp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#daidptzdvp .gt_font_normal {
  font-weight: normal;
}

#daidptzdvp .gt_font_bold {
  font-weight: bold;
}

#daidptzdvp .gt_font_italic {
  font-style: italic;
}

#daidptzdvp .gt_super {
  font-size: 65%;
}

#daidptzdvp .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#daidptzdvp .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#daidptzdvp .gt_indent_1 {
  text-indent: 5px;
}

#daidptzdvp .gt_indent_2 {
  text-indent: 10px;
}

#daidptzdvp .gt_indent_3 {
  text-indent: 15px;
}

#daidptzdvp .gt_indent_4 {
  text-indent: 20px;
}

#daidptzdvp .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_heading">
      <td colspan="4" class="gt_heading gt_title gt_font_normal gt_bottom_border" style="">Largest Stock in Sector, Monthly Returns</td>
    </tr>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Symbol">Symbol</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Volatility">Volatility</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Avg Return">Avg Return</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Correlation(*)">Correlation(*)</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="symbol" class="gt_row gt_left">AAPL</td>
<td headers="volatility" class="gt_row gt_right">8.06%</td>
<td headers="avg_return" class="gt_row gt_right">1.85%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.35</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">AMZN</td>
<td headers="volatility" class="gt_row gt_right">8.68%</td>
<td headers="avg_return" class="gt_row gt_right">1.84%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.29</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">BRK-B</td>
<td headers="volatility" class="gt_row gt_right">4.81%</td>
<td headers="avg_return" class="gt_row gt_right">1.03%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.44</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">CMCSA</td>
<td headers="volatility" class="gt_row gt_right">6.50%</td>
<td headers="avg_return" class="gt_row gt_right">0.77%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.38</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">LIN</td>
<td headers="volatility" class="gt_row gt_right">5.21%</td>
<td headers="avg_return" class="gt_row gt_right">1.15%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.42</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">LLY</td>
<td headers="volatility" class="gt_row gt_right">6.47%</td>
<td headers="avg_return" class="gt_row gt_right">2.08%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.11</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">LVMUY</td>
<td headers="volatility" class="gt_row gt_right">6.92%</td>
<td headers="avg_return" class="gt_row gt_right">1.31%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.38</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">NEE</td>
<td headers="volatility" class="gt_row gt_right">5.59%</td>
<td headers="avg_return" class="gt_row gt_right">1.11%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.21</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">NHYDY</td>
<td headers="volatility" class="gt_row gt_right">10.39%</td>
<td headers="avg_return" class="gt_row gt_right">0.40%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.32</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">PLD</td>
<td headers="volatility" class="gt_row gt_right">6.40%</td>
<td headers="avg_return" class="gt_row gt_right">1.07%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.37</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">UNP</td>
<td headers="volatility" class="gt_row gt_right">6.33%</td>
<td headers="avg_return" class="gt_row gt_right">1.12%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.39</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">WMT</td>
<td headers="volatility" class="gt_row gt_right">5.14%</td>
<td headers="avg_return" class="gt_row gt_right">0.80%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.27</td></tr>
    <tr><td headers="symbol" class="gt_row gt_left">XOM</td>
<td headers="volatility" class="gt_row gt_right">7.52%</td>
<td headers="avg_return" class="gt_row gt_right">0.46%</td>
<td headers="avg_correlation" class="gt_row gt_right">0.28</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="4"> (*) Pairwise average(ρ): matrix row/column average excluding diagonal</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
</section>
<section id="visualize-correlation" class="level3">
<h3 class="anchored" data-anchor-id="visualize-correlation">Visualize Correlation</h3>
<p>These step took me too long because I couldn’t wrestle corrplot/ggcorrplot to my ends. I tried various packages but finally settled on <a href="https://corrr.tidymodels.org/index.html">the corrr package</a> due to its elegant/tidy construction; e.g., if you use ggplot, you can guess its parameters. As <a href="https://corrr.tidymodels.org/articles/using-corrr.html">the authors write</a>,</p>
<blockquote class="blockquote">
<p>At first, a correlation data frame might seem like an unnecessary complexity compared to the traditional matrix. However, the purpose of corrr is to help use explore these correlations, not to do mathematical or statistical operations. Thus, by having the correlations in a data frame, we can make use of packages that help us work with data frames like dplyr, tidyr, ggplot2, and focus on using data pipelines</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrr)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>colors_corr_plot <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"firebrick3"</span>, <span class="st">"firebrick1"</span>, <span class="st">"yellow"</span>, <span class="st">"seagreen1"</span>, <span class="st">"seagreen4"</span>))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>plot_corr <span class="ot">&lt;-</span> <span class="cf">function</span>(matrix, title) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    matrix_df <span class="ot">&lt;-</span> <span class="fu">as_cordf</span>(matrix) <span class="sc">|&gt;</span> <span class="fu">shave</span>()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    matrix_df <span class="sc">|&gt;</span> <span class="fu">rplot</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">print_cor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">colors =</span> <span class="fu">colors_corr_plot</span>(<span class="dv">5</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>get_corr_matrices <span class="ot">&lt;-</span> <span class="cf">function</span>(row_df){</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    analyze_this <span class="ot">&lt;-</span> row_df <span class="sc">|&gt;</span> </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pull</span>(analysis)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    corr_daily_matrix   <span class="ot">&lt;-</span> analyze_this[[<span class="dv">1</span>]][[<span class="st">"daily"</span>]]<span class="sc">$</span>corr_matrix</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    corr_weekly_matrix  <span class="ot">&lt;-</span> analyze_this[[<span class="dv">1</span>]][[<span class="st">"weekly"</span>]]<span class="sc">$</span>corr_matrix</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    corr_monthly_matrix <span class="ot">&lt;-</span> analyze_this[[<span class="dv">1</span>]][[<span class="st">"monthly"</span>]]<span class="sc">$</span>corr_matrix</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">corr_daily_matrix =</span> corr_daily_matrix,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">corr_weekly_matrix =</span> corr_weekly_matrix,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">corr_monthly_matrix =</span> corr_monthly_matrix</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>select_row_1 <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> <span class="fu">filter</span>(set_id <span class="sc">==</span> <span class="st">"9_styles"</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>three_matrices <span class="ot">&lt;-</span> <span class="fu">get_corr_matrices</span>(select_row_1)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>cp1 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_daily_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"9_styles, daily"</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co"># cp2 &lt;- three_matrices$corr_weekly_matrix |&gt; plot_corr("9_styles, weekly")</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>cp3 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_monthly_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"9_styles, monthly"</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>select_row_2 <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> <span class="fu">filter</span>(set_id <span class="sc">==</span> <span class="st">"11_sectors"</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>three_matrices <span class="ot">&lt;-</span> <span class="fu">get_corr_matrices</span>(select_row_2)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>cp4 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_daily_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"11_sectors, daily"</span>) <span class="sc">+</span> </span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co"># cp5 &lt;- three_matrices$corr_weekly_matrix |&gt; plot_corr("11_sectors, weekly")</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>cp6 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_monthly_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"11_sectors, monthly"</span>) <span class="sc">+</span> </span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>select_row_3 <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> <span class="fu">filter</span>(set_id <span class="sc">==</span> <span class="st">"13_top_in_sector"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>three_matrices <span class="ot">&lt;-</span> <span class="fu">get_corr_matrices</span>(select_row_3)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>cp7 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_daily_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"13_top_in_sector, daily"</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"># cp8 &lt;- three_matrices$corr_weekly_matrix |&gt; plot_corr("13_top_in_sector, weekly")</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>cp9 <span class="ot">&lt;-</span> three_matrices<span class="sc">$</span>corr_monthly_matrix <span class="sc">|&gt;</span> <span class="fu">plot_corr</span>(<span class="st">"13_top_in_sector, monthly"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>cp1 <span class="sc">+</span> cp4 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="st">"Daily frequency: Styles vs Sectors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cp3 <span class="sc">+</span> cp6 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="st">"Monthly frequency: Styles vs Sectors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>cp7 <span class="sc">+</span> cp9 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="st">"Largest Stock in Each Sector: Daily vs Monthly"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="simulation" class="level2">
<h2 class="anchored" data-anchor-id="simulation">Simulation</h2>
<p>There are four steps here: select the portfolio, bias the random weights (if desired), setup the simulation, and run the simulation.</p>
<section id="simulation-1.-select-the-portfolio-set-of-tickerssymbols" class="level3">
<h3 class="anchored" data-anchor-id="simulation-1.-select-the-portfolio-set-of-tickerssymbols">Simulation: 1. Select the portfolio (set of tickers/symbols)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting the desired set (e.g., "Set 1")</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>select_set <span class="ot">&lt;-</span> stock_sets <span class="sc">|&gt;</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(set_id <span class="sc">==</span> <span class="st">"11_sectors"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(<span class="st">"analysis"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>analyze_set <span class="ot">&lt;-</span> select_set[[<span class="dv">1</span>]]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>analyze_period <span class="ot">&lt;-</span> analyze_set<span class="sc">$</span>monthly</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting components from the selected set</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>exp_returns_period <span class="ot">&lt;-</span> analyze_period<span class="sc">$</span>avg_returns<span class="sc">$</span>avg_return</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(exp_returns_period) <span class="ot">&lt;-</span> analyze_period<span class="sc">$</span>avg_returns<span class="sc">$</span>symbol</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>volatilities_period <span class="ot">&lt;-</span> analyze_period<span class="sc">$</span>volatilities<span class="sc">$</span>volatility</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(volatilities_period) <span class="ot">&lt;-</span> analyze_period<span class="sc">$</span>volatilities<span class="sc">$</span>symbol</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>corr_matrix_period <span class="ot">&lt;-</span> analyze_period<span class="sc">$</span>corr_matrix</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>num_stocks_period <span class="ot">&lt;-</span> <span class="fu">length</span>(volatilities_period)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulation-2.-bias-the-random-weights" class="level3">
<h3 class="anchored" data-anchor-id="simulation-2.-bias-the-random-weights">Simulation: 2. Bias the random weights</h3>
<p>This is an experiment to see if we can bias the random weights to get a better result. Rather than deduce a formula, I decided to ask, what is a more (or less) desirable feature of a diversifying asset? (in the mean-variance framework, it’s an asset with low marginal volatility). I decided to include the Sharpe ratio, expected utility (i.e., the expected rate of return minus half the risk aversion coeffient multiplied by the variance), and average correlation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>calculate_desirability <span class="ot">&lt;-</span> <span class="cf">function</span>(exp_returns, volatilities, corr_matrix, A, risk_free_rate, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                                   utility_weight, sharpe_weight, correlation_weight) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the variance as the square of volatility</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    variance <span class="ot">&lt;-</span> volatilities<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the utility for each sector</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    utility <span class="ot">&lt;-</span> exp_returns <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> A <span class="sc">*</span> variance</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the Sharpe ratio for each sector</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="ot">&lt;-</span> (exp_returns <span class="sc">-</span> risk_free_rate) <span class="sc">/</span> volatilities</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the average correlation for each sector</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    avg_correlation <span class="ot">&lt;-</span> <span class="fu">apply</span>(corr_matrix, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">mean</span>(x[<span class="sc">-</span><span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">1</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.matrix</span>(corr_matrix, <span class="st">"avg_correlation.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the desirability score</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    desirability_score <span class="ot">&lt;-</span> utility_weight <span class="sc">*</span> (utility <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        sharpe_weight <span class="sc">*</span> (sharpe_ratio <span class="sc">*</span> <span class="dv">3</span> ) <span class="sc">-</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        correlation_weight <span class="sc">*</span> avg_correlation <span class="co"># Negative because lower correlation is better</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a data frame for sector desirability</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    desirability_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sector =</span> <span class="fu">names</span>(exp_returns),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">exp_returns =</span> exp_returns,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">volatilities =</span> volatilities,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">utility =</span> utility,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sharpe_ratio =</span> sharpe_ratio,</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">avg_correlation =</span> avg_correlation,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">desirability_score =</span> desirability_score)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by desirability score</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    desirability_df <span class="ot">&lt;-</span> desirability_df[<span class="fu">order</span>(<span class="sc">-</span>desirability_df<span class="sc">$</span>desirability_score),]</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(desirability_df)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Example parameters</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Risk aversion coefficient</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>risk_free_rate <span class="ot">&lt;-</span> <span class="fl">0.0</span>  <span class="co"># Risk-free rate</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>utility_weight <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>sharpe_weight <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>correlation_weight <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate desirability using the extracted components</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>sector_desirability <span class="ot">&lt;-</span> <span class="fu">calculate_desirability</span>(exp_returns_period, volatilities_period, corr_matrix_period, A, risk_free_rate, utility_weight, sharpe_weight, correlation_weight)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>sector_desirability <span class="sc">|&gt;</span> <span class="fu">gt</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cols_label</span>(<span class="at">sector =</span> <span class="st">"Ticker"</span>,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>               <span class="at">exp_returns =</span> <span class="st">"Return"</span>,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>               <span class="at">volatilities =</span> <span class="st">"Vol"</span>,</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>               <span class="at">utility =</span> <span class="st">"Utility"</span>,</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>               <span class="at">sharpe_ratio =</span> <span class="st">"Sharpe"</span>,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>               <span class="at">avg_correlation =</span> <span class="st">"Avg Corr"</span>,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>               <span class="at">desirability_score =</span> <span class="st">"Desirability"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_percent</span>(<span class="at">columns =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">decimals =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="diqwhwjvit" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#diqwhwjvit table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#diqwhwjvit thead, #diqwhwjvit tbody, #diqwhwjvit tfoot, #diqwhwjvit tr, #diqwhwjvit td, #diqwhwjvit th {
  border-style: none;
}

#diqwhwjvit p {
  margin: 0;
  padding: 0;
}

#diqwhwjvit .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#diqwhwjvit .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#diqwhwjvit .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#diqwhwjvit .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#diqwhwjvit .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#diqwhwjvit .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#diqwhwjvit .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#diqwhwjvit .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#diqwhwjvit .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#diqwhwjvit .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#diqwhwjvit .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#diqwhwjvit .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#diqwhwjvit .gt_spanner_row {
  border-bottom-style: hidden;
}

#diqwhwjvit .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#diqwhwjvit .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#diqwhwjvit .gt_from_md > :first-child {
  margin-top: 0;
}

#diqwhwjvit .gt_from_md > :last-child {
  margin-bottom: 0;
}

#diqwhwjvit .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#diqwhwjvit .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#diqwhwjvit .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#diqwhwjvit .gt_row_group_first td {
  border-top-width: 2px;
}

#diqwhwjvit .gt_row_group_first th {
  border-top-width: 2px;
}

#diqwhwjvit .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#diqwhwjvit .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#diqwhwjvit .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#diqwhwjvit .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#diqwhwjvit .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#diqwhwjvit .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#diqwhwjvit .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#diqwhwjvit .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#diqwhwjvit .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#diqwhwjvit .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#diqwhwjvit .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#diqwhwjvit .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#diqwhwjvit .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#diqwhwjvit .gt_left {
  text-align: left;
}

#diqwhwjvit .gt_center {
  text-align: center;
}

#diqwhwjvit .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#diqwhwjvit .gt_font_normal {
  font-weight: normal;
}

#diqwhwjvit .gt_font_bold {
  font-weight: bold;
}

#diqwhwjvit .gt_font_italic {
  font-style: italic;
}

#diqwhwjvit .gt_super {
  font-size: 65%;
}

#diqwhwjvit .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#diqwhwjvit .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#diqwhwjvit .gt_indent_1 {
  text-indent: 5px;
}

#diqwhwjvit .gt_indent_2 {
  text-indent: 10px;
}

#diqwhwjvit .gt_indent_3 {
  text-indent: 15px;
}

#diqwhwjvit .gt_indent_4 {
  text-indent: 20px;
}

#diqwhwjvit .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Ticker">Ticker</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Return">Return</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Vol">Vol</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Utility">Utility</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Sharpe">Sharpe</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Avg Corr">Avg Corr</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Desirability">Desirability</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="sector" class="gt_row gt_left">XLK</td>
<td headers="exp_returns" class="gt_row gt_right">1.50%</td>
<td headers="volatilities" class="gt_row gt_right">5.17%</td>
<td headers="utility" class="gt_row gt_right">0.0110</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.2909</td>
<td headers="avg_correlation" class="gt_row gt_right">0.5422</td>
<td headers="desirability_score" class="gt_row gt_right">0.5171</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLV</td>
<td headers="exp_returns" class="gt_row gt_right">1.01%</td>
<td headers="volatilities" class="gt_row gt_right">3.99%</td>
<td headers="utility" class="gt_row gt_right">0.0077</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.2534</td>
<td headers="avg_correlation" class="gt_row gt_right">0.7093</td>
<td headers="desirability_score" class="gt_row gt_right">0.3230</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLP</td>
<td headers="exp_returns" class="gt_row gt_right">0.72%</td>
<td headers="volatilities" class="gt_row gt_right">3.64%</td>
<td headers="utility" class="gt_row gt_right">0.0052</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1983</td>
<td headers="avg_correlation" class="gt_row gt_right">0.5484</td>
<td headers="desirability_score" class="gt_row gt_right">0.2304</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLY</td>
<td headers="exp_returns" class="gt_row gt_right">1.04%</td>
<td headers="volatilities" class="gt_row gt_right">5.42%</td>
<td headers="utility" class="gt_row gt_right">0.0060</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1918</td>
<td headers="avg_correlation" class="gt_row gt_right">0.6908</td>
<td headers="desirability_score" class="gt_row gt_right">0.2027</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLI</td>
<td headers="exp_returns" class="gt_row gt_right">0.91%</td>
<td headers="volatilities" class="gt_row gt_right">5.12%</td>
<td headers="utility" class="gt_row gt_right">0.0052</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1785</td>
<td headers="avg_correlation" class="gt_row gt_right">0.6589</td>
<td headers="desirability_score" class="gt_row gt_right">0.1728</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLF</td>
<td headers="exp_returns" class="gt_row gt_right">0.87%</td>
<td headers="volatilities" class="gt_row gt_right">5.44%</td>
<td headers="utility" class="gt_row gt_right">0.0042</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1594</td>
<td headers="avg_correlation" class="gt_row gt_right">0.7085</td>
<td headers="desirability_score" class="gt_row gt_right">0.1057</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLU</td>
<td headers="exp_returns" class="gt_row gt_right">0.70%</td>
<td headers="volatilities" class="gt_row gt_right">4.35%</td>
<td headers="utility" class="gt_row gt_right">0.0042</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1613</td>
<td headers="avg_correlation" class="gt_row gt_right">0.7629</td>
<td headers="desirability_score" class="gt_row gt_right">0.0899</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLB</td>
<td headers="exp_returns" class="gt_row gt_right">0.73%</td>
<td headers="volatilities" class="gt_row gt_right">5.30%</td>
<td headers="utility" class="gt_row gt_right">0.0031</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.1372</td>
<td headers="avg_correlation" class="gt_row gt_right">0.6885</td>
<td headers="desirability_score" class="gt_row gt_right">0.0499</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLC</td>
<td headers="exp_returns" class="gt_row gt_right">0.58%</td>
<td headers="volatilities" class="gt_row gt_right">6.09%</td>
<td headers="utility" class="gt_row gt_right">0.0003</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.0959</td>
<td headers="avg_correlation" class="gt_row gt_right">0.6580</td>
<td headers="desirability_score" class="gt_row gt_right">−0.0738</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLRE</td>
<td headers="exp_returns" class="gt_row gt_right">0.46%</td>
<td headers="volatilities" class="gt_row gt_right">5.01%</td>
<td headers="utility" class="gt_row gt_right">0.0008</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.0919</td>
<td headers="avg_correlation" class="gt_row gt_right">0.7664</td>
<td headers="desirability_score" class="gt_row gt_right">−0.0944</td></tr>
    <tr><td headers="sector" class="gt_row gt_left">XLE</td>
<td headers="exp_returns" class="gt_row gt_right">0.40%</td>
<td headers="volatilities" class="gt_row gt_right">8.35%</td>
<td headers="utility" class="gt_row gt_right">−0.0064</td>
<td headers="sharpe_ratio" class="gt_row gt_right">0.0483</td>
<td headers="avg_correlation" class="gt_row gt_right">0.7167</td>
<td headers="desirability_score" class="gt_row gt_right">−0.3499</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</section>
<section id="simulation-3.-setup-the-simulation" class="level3">
<h3 class="anchored" data-anchor-id="simulation-3.-setup-the-simulation">Simulation: 3. Setup the simulation</h3>
<p>The <strong>get_random_weights</strong> function returns a dataframe of random weights (that sum to 1). Each column is a set of weights for a single simulation.</p>
<p>This adds one innovation to the (my previous) naive approach. As previously, I still assume: the <em>expected return</em> for each stock is the average return for that stock over the entire period; the <em>volatility</em> for each stock is the average volatility for that stock over the entire period; and the <em>correlation matrix</em> (which obviously implies the <em>covariance matrix</em>) is computed from the pairwise (log) return vectors. In short, I’m assuming that the future will be like the past.</p>
<p>The innovation is that I bias the random weights to slightly favor the stocks with the highest “desirability” scores, as defined in the previous chunk. Desirability is just a weighted average of Utility, Sharpe ratio and (the inverse of) average correlation. Once random weights are selected, the portfolio return and volatility are calculated; and those don’t depend on the bias. The idea here is simply to (probably <em>slightly</em>) favor the simulation’s density toward the efficient segment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># returns a data frame of random weights</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># rows = weight per stock; columns = number of simulations</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>get_random_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(num_stocks, num_simulations, probabilities, <span class="at">row_names =</span> <span class="cn">NULL</span>) {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">47391</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    weights_df <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> num_stocks, <span class="at">ncol =</span> num_simulations)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_simulations) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate weights influenced by probabilities</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        weights <span class="ot">&lt;-</span> <span class="fu">runif</span>(num_stocks) <span class="sc">*</span> probabilities</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        weights_df[, i] <span class="ot">&lt;-</span> weights <span class="sc">/</span> <span class="fu">sum</span>(weights)  <span class="co"># Normalize the weights</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    weights_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(weights_df)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(row_names) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(row_names) <span class="sc">==</span> num_stocks) {</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(weights_df) <span class="ot">&lt;-</span> row_names</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weights_df)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># single simulation: given a set of weights, computes the expected return and volatility</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>port_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(exp_returns, volatilities, corr_matrix, weights) {</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="ot">&lt;-</span> <span class="fu">outer</span>(volatilities, volatilities) <span class="sc">*</span> corr_matrix</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    port_variance <span class="ot">&lt;-</span> <span class="fu">t</span>(weights) <span class="sc">%*%</span> cov_matrix <span class="sc">%*%</span> weights</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    port_exp_return <span class="ot">&lt;-</span> <span class="fu">sum</span>(weights <span class="sc">*</span> exp_returns)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">exp_returns =</span> exp_returns, </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">volatilities =</span> volatilities,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">cov_matrix =</span> cov_matrix, </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">corr_matrix =</span> corr_matrix,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                <span class="at">port_variance =</span> port_variance,</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                <span class="at">port_exp_return =</span> port_exp_return))</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="co"># runs a port_simulation for each column in the weights_df</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>run_sims <span class="ot">&lt;-</span> <span class="cf">function</span>(exp_returns, volatilities, corr_matrix, weights_df) {</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    simulations <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(weights_df), <span class="sc">~</span> {</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        weights_vector <span class="ot">&lt;-</span> weights_df[, .x]</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">port_sim</span>(exp_returns, volatilities, corr_matrix, weights_vector)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(simulations)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulation-4.-run-the-simulation-on-a-single-set" class="level3">
<h3 class="anchored" data-anchor-id="simulation-4.-run-the-simulation-on-a-single-set">Simulation: 4. Run the simulation (on a single set)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>num_sims <span class="ot">&lt;-</span> <span class="dv">10000</span>  <span class="co"># Set the number of simulations</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>sector_desirability<span class="sc">$</span>desirability_score <span class="ot">&lt;-</span> <span class="fu">pmax</span>(sector_desirability<span class="sc">$</span>desirability_score, <span class="dv">0</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>total_score <span class="ot">&lt;-</span> <span class="fu">sum</span>(sector_desirability<span class="sc">$</span>desirability_score)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>probabilities <span class="ot">&lt;-</span> sector_desirability<span class="sc">$</span>desirability_score <span class="sc">/</span> total_score</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(probabilities) <span class="ot">&lt;-</span> sector_desirability<span class="sc">$</span>sector</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>ordered_probabilities <span class="ot">&lt;-</span> probabilities[<span class="fu">names</span>(exp_returns_period)]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>row_symbols <span class="ot">&lt;-</span> <span class="fu">names</span>(exp_returns_period)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>random_weights_df_period <span class="ot">&lt;-</span> <span class="fu">get_random_weights</span>(num_stocks_period, num_sims,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                                               ordered_probabilities, <span class="at">row_names =</span> row_symbols)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># View first 5 columns (= simulations/trials)</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>random_weights_df_period <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             V1         V2         V3         V4          V5
XLB  0.02904022 0.05416135 0.02778490 0.02113182 0.068640582
XLC  0.00000000 0.00000000 0.00000000 0.00000000 0.000000000
XLE  0.00000000 0.00000000 0.00000000 0.00000000 0.000000000
XLF  0.07715564 0.05391847 0.11792040 0.04413685 0.032498297
XLI  0.07038140 0.14379002 0.10358717 0.15823493 0.106281860
XLK  0.39217487 0.08140458 0.17201663 0.24347196 0.290418025
XLP  0.10247948 0.30004556 0.16088140 0.19679704 0.079391443
XLRE 0.00000000 0.00000000 0.00000000 0.00000000 0.000000000
XLU  0.01658246 0.08766279 0.13995496 0.01986227 0.006779211
XLV  0.23783284 0.04282421 0.04622476 0.22763656 0.189368775
XLY  0.07435309 0.23619302 0.23162977 0.08872856 0.226621805</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sim_results_period <span class="ot">&lt;-</span> <span class="fu">run_sims</span>(exp_returns_period, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                              volatilities_period, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                              corr_matrix_period, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                              random_weights_df_period)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Testing</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(sim_results_period[[1]])</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>results_df_period <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(sim_results_period, <span class="sc">~</span> <span class="fu">data.frame</span>(<span class="at">Exp_Return =</span> .x<span class="sc">$</span>port_exp_return, </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">Std_Dev =</span> <span class="fu">sqrt</span>(.x<span class="sc">$</span>port_variance)))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the risk-free rate</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>risk_free_cml_1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>risk_free_cml_2 <span class="ot">&lt;-</span> <span class="fl">0.005</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the Sharpe Ratio for each simulation</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>results_df_period <span class="ot">&lt;-</span> results_df_period <span class="sc">|&gt;</span> </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sharpe_Ratio_1 =</span> (Exp_Return <span class="sc">-</span> risk_free_cml_1) <span class="sc">/</span> Std_Dev,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sharpe_Ratio_2 =</span> (Exp_Return <span class="sc">-</span> risk_free_cml_2) <span class="sc">/</span> Std_Dev</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the row with the highest Sharpe Ratio</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>best_sim_1 <span class="ot">&lt;-</span> results_df_period[<span class="fu">which.max</span>(results_df_period<span class="sc">$</span>Sharpe_Ratio_1), ]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>best_sim_2 <span class="ot">&lt;-</span> results_df_period[<span class="fu">which.max</span>(results_df_period<span class="sc">$</span>Sharpe_Ratio_2), ]</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the best simulation result</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(best_sim_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Exp_Return    Std_Dev Sharpe_Ratio_1 Sharpe_Ratio_2
5333 0.01181061 0.03765077      0.3136885      0.1808891</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(best_sim_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Exp_Return    Std_Dev Sharpe_Ratio_1 Sharpe_Ratio_2
6340  0.0129082 0.04164321      0.3099714      0.1899038</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View summarized results for daily returns</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(results_df_period))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Exp_Return    Std_Dev Sharpe_Ratio_1 Sharpe_Ratio_2
1 0.011451646 0.03877509      0.2953351      0.1663864
2 0.009070019 0.03843242      0.2359992      0.1059007
3 0.009775922 0.03997072      0.2445771      0.1194855
4 0.010426930 0.03721517      0.2801795      0.1458257
5 0.011009263 0.03991819      0.2757956      0.1505394
6 0.011803124 0.04004291      0.2947619      0.1698958</code></pre>
</div>
</div>
</section>
</section>
<section id="visualize-the-results" class="level2">
<h2 class="anchored" data-anchor-id="visualize-the-results">Visualize the results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> results_df_period <span class="co"># continuity from prior</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> results_df <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Std_Dev) <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">is_efficient =</span> Exp_Return <span class="sc">&gt;=</span> <span class="fu">cummax</span>(Exp_Return))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>efficient_portfolios <span class="ot">&lt;-</span> results_df <span class="sc">|&gt;</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Std_Dev)  <span class="sc">|&gt;</span> </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cummax_return =</span> <span class="fu">cummax</span>(Exp_Return)) <span class="sc">|&gt;</span> </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Exp_Return <span class="sc">&gt;=</span> cummax_return)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>efficient_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(Exp_Return <span class="sc">~</span> <span class="fu">poly</span>(Std_Dev, <span class="dv">2</span>), <span class="at">data =</span> efficient_portfolios)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> Std_Dev, <span class="at">y =</span> Exp_Return, <span class="at">color =</span> is_efficient)) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"azure2"</span>, <span class="st">"springgreen4"</span>)) <span class="sc">+</span> </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> Std_Dev, <span class="at">y =</span> Exp_Return)) <span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> is_efficient), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  <span class="co"># Default size for all points</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(results_df, is_efficient), </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">color =</span> is_efficient), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span>  <span class="co"># Larger size for efficient points</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"azure2"</span>, <span class="st">"springgreen4"</span>)) <span class="sc">+</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> efficient_portfolios, <span class="fu">aes</span>(<span class="at">x =</span> Std_Dev, <span class="at">y =</span> Exp_Return), <span class="at">colour =</span> <span class="st">"springgreen2"</span>) <span class="sc">+</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> Std_Dev, <span class="at">y =</span> Exp_Return)) <span class="sc">+</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"azure2"</span>) <span class="sc">+</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">data =</span> efficient_portfolios, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>), </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="st">"springgreen4"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Std Dev (Risk)"</span>,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Return"</span>) <span class="sc">+</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.0330</span>, <span class="fl">0.050</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.0075</span>, <span class="fl">0.0140</span>)) <span class="sc">+</span> </span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate a metric, Sharpe, that can inform COLOR fill</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ... but it will only be based on the first risk-free rate!</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> results_df <span class="sc">%&gt;%</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">efficiency =</span> (Exp_Return <span class="sc">-</span> risk_free_cml_1)<span class="sc">/</span> Std_Dev)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>slope_cml_1 <span class="ot">&lt;-</span> (best_sim_1<span class="sc">$</span>Exp_Return <span class="sc">-</span> risk_free_cml_1) <span class="sc">/</span> best_sim_1<span class="sc">$</span>Std_Dev</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>slope_cml_2 <span class="ot">&lt;-</span> (best_sim_2<span class="sc">$</span>Exp_Return <span class="sc">-</span> risk_free_cml_2) <span class="sc">/</span> best_sim_2<span class="sc">$</span>Std_Dev</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>extended_std_dev <span class="ot">&lt;-</span> <span class="fu">max</span>(results_df_period<span class="sc">$</span>Std_Dev) <span class="sc">*</span> <span class="fl">1.2</span>  <span class="co"># For example, 20% beyond the max std dev in the data</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>extended_exp_return_1 <span class="ot">&lt;-</span> risk_free_cml_1 <span class="sc">+</span> slope_cml_1 <span class="sc">*</span> extended_std_dev</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>extended_exp_return_2 <span class="ot">&lt;-</span> risk_free_cml_2 <span class="sc">+</span> slope_cml_2 <span class="sc">*</span> extended_std_dev</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> Std_Dev, <span class="at">y =</span> Exp_Return, <span class="at">color =</span> efficiency)) <span class="sc">+</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_gradientn</span>(<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"firebrick1"</span>, <span class="st">"lightgoldenrod1"</span>, <span class="st">"springgreen2"</span>),</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>                          <span class="at">values =</span> scales<span class="sc">::</span><span class="fu">rescale</span>(<span class="fu">c</span>(<span class="fu">min</span>(results_df<span class="sc">$</span>efficiency), </span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>                                                     <span class="fu">max</span>(results_df<span class="sc">$</span>efficiency)))) <span class="sc">+</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> risk_free_cml_1, <span class="at">xend =</span> extended_std_dev, <span class="at">yend =</span> extended_exp_return_1), </span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"dodgerblue2"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.0330</span>, <span class="fl">0.050</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.0075</span>, <span class="fl">0.0140</span>)) <span class="sc">+</span> </span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Std Dev (Risk)"</span>,</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Return"</span>, </span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"efficiency"</span>)</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="add-the-second-cml" class="level3">
<h3 class="anchored" data-anchor-id="add-the-second-cml">Add the second CML</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> p4 <span class="sc">+</span> <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> risk_free_cml_2, <span class="at">xend =</span> extended_std_dev, <span class="at">yend =</span> extended_exp_return_2), </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"purple2"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>p5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="this-is-for-the-social-thumb" class="level3">
<h3 class="anchored" data-anchor-id="this-is-for-the-social-thumb">This is for the social thumb</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cp9_thumb <span class="ot">&lt;-</span> cp9 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>(cp7 <span class="sc">+</span> cp9_thumb) <span class="sc">/</span> (p2 <span class="sc">+</span> p4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>