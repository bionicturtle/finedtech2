<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Harper, CFA, FRM">
<meta name="dcterms.date" content="2024-05-15">
<meta name="description" content="v1 of the stress test simulator (scenario vector influences input accounts)">

<title>Stress test (simulation) of WFC balance sheet and income statement â€“ finedtech by David Harper, CFA, FRM</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">finedtech by David Harper, CFA, FRM</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About David</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bionicturtle"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/davidharper2/"> <i class="bi bi-instagram" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Stress test (simulation) of WFC balance sheet and income statement</h1>
                  <div>
        <div class="description">
          v1 of the stress test simulator (scenario vector influences input accounts)
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>David Harper, CFA, FRM </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This v1 simulator is discussed on my <a href="https://aibucks.substack.com/">ai bucks substack</a>.</p>
<section id="first-code-block-pull-statement-data-into-tidy-dataframes-balance_df-and-income_df" class="level2">
<h2 class="anchored" data-anchor-id="first-code-block-pull-statement-data-into-tidy-dataframes-balance_df-and-income_df">First code block: pull statement data into tidy dataframes: balance_df and income_df</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>balance_df <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"balance_df.rds"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>income_df <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"income_df.rds"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df (actual calcs below)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df: Calculated Variables (7) as pulled from 10Q</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Debt Securities (TotDebtSec):   Sum of Trading, Available-for-Sale, and Held-to-Maturity Debt Securities.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Net Loans (NetLoans):                 Loans plus Allowance for Loan Losses.</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Deposits (TotDep):              Sum of Noninterest-Bearing and Interest-Bearing Deposits.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Liabilities (TotLiab):          Sum of Total Deposits, Short-Term Borrowings, Derivative Liabilities, </span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       Accrued Expenses and Other Liabilities, and Long-Term Debt.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Shareholders' Equity (TotSHREq):Sum of Preferred Stock, Common Stock, Additional Paid-In Capital, </span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       Retained  Earnings, Accumulated Other Comprehensive Loss, Treasury Stock, </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                                       Unearned ESOP Shares, and Noncontrolling Interests.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Assets (TotAssets):             Sum of all asset accounts plus Total Liabilities and Equity.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Liabilities and Equity (TotLiabEq):Sum of Total Liabilities and Total Shareholders' Equity.</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df: Calculated Variables (7) with shorter names</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotDebtSec &lt;- balance_df$TradDebtSec + balance_df$AvailSaleDebtSec + balance_df$HeldMatDebtSec</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$NetLoans   &lt;- balance_df$Loans + balance_df$LoanLossAllow</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotDep     &lt;- balance_df$NonIntBearDep + balance_df$IntBearDep</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotLiab    &lt;- balance_df$TotDep + balance_df$STBorrow + balance_df$DerivLiab + balance_df$AccExpOthLiab +</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                          balance_df$LTDebt</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotSHREq   &lt;- balance_df$PrefStock + balance_df$ComStock + balance_df$AddlPaidCap + balance_df$RetEarn +</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                          balance_df$AOCL + balance_df$TreasStock + balance_df$UnearnESOP + balance_df$NonCtrlInt</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotAssets  &lt;- balance_df$Cash + balance_df$IntEarnDep + balance_df$FedFundsSold + balance_df$TotDebtSec +</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">#                          balance_df$LoansForSale + balance_df$NetLoans + balance_df$MortServRights + balance_df$PremEquip + </span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">#                          balance_df$Goodwill + balance_df$DerivAssets + balance_df$EquitySec + balance_df$OthAssets + </span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df$TotLiabEq  &lt;- balance_df$TotLiab + balance_df$TotSHREq</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df: Input Variables (4)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Loans (Loans)</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Allowance for Loan Losses (LoanLossAllow)</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Noninterest Bearing Deposits (NonIntBearDep)</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Interest Bearing Deposits (IntBearDep)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df: Drift Variables</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Cash (Cash)</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Interest Earning Deposits (IntEarnDep)</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Federal Funds Sold (FedFundsSold)</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Trading Debt Securities (TradDebtSec)</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Available-for-Sale Debt Securities (AvailSaleDebtSec)</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Held-to-Maturity Debt Securities (HeldMatDebtSec)</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Loans Held for Sale (LoansForSale)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Mortgage Servicing Rights (MortServRights)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Premises and Equipment (PremEquip)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Goodwill</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Derivative Assets (DerivAssets)</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Equity Securities (EquitySec)</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Other Assets (OthAssets)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Short-Term Borrowings (STBorrow)</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Derivative Liabilities (DerivLiab)</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Accrued Expenses and Other Liabilities (AccExpOthLiab)</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Long-Term Debt (LTDebt)</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Preferred Stock (PrefStock)</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Common Stock (ComStock)</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional Paid-In Capital (AddlPaidCap)</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Retained Earnings (RetEarn)</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Accumulated Other Comprehensive Loss (AOCL)</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Treasury Stock (TreasStock)</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Unearned ESOP Shares (UnearnESOP)</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Noncontrolling Interests (NonCtrlInt)</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df: Calculated variables (10)</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$TotIntInc &lt;- income_df$DebtSec + income_df$LoansSale + income_df$Loans + income_df$EqSec + income_df$OthIntInc</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$TotIntExp &lt;- income_df$DepIntExp + income_df$STBIntExp + income_df$LTBIntExp + income_df$OthIntExp</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$NetIntInc &lt;- income_df$TotIntInc - income_df$TotIntExp</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$TotnonIntInc &lt;- income_df$DepLendFees + income_df$InvAdvFees + income_df$CommBrkFees + income_df$InvBankFees +</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co">#                           income_df$CardFees + income_df$MortBank + income_df$NetGainTrade + income_df$OthNonIntInc</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$TotRev &lt;- income_df$NetIntInc + income_df$TotNonIntInc</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$TotNonIntExp &lt;- income_df$Personnel + income_df$TechTelEquip + income_df$Occupancy + </span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="co">#                           income_df$OperLoss + income_df$ProfOutServ + </span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co">#                           income_df$AdvPromo + income_df$OthNonIntExp</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$IncBefTax &lt;- income_df$TotRev - income_df$TotNonIntExp - income_df$ProvCredLoss</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$NetIncBefNCI &lt;- income_df$IncBefTax - income_df$TaxExp</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$WFNetInc &lt;- income_df$NetIncBefNCI - income_df$NetIncLossNCI</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df$WFNetIncCS &lt;- income_df$WFNetInc - income_df$PrefStkDiv</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df: Input Variables (6) ... directly impacted by external macroeconomic changes and focus in stress test scenarios</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Loans (Loans):            Total amount of loans issued, sensitive to economic changes affecting credit demand and default rates.</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Equity Securities (EqSec):Investments in equity securities, influenced by market valuations and economic conditions.</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Other Interest Income (OthIntInc): Income generated from various miscellaneous financial sources, potentially sensitive to</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    interest rate changes and economic conditions.</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Provision for Credit Losses (ProvCredLoss): Reserves set aside to cover potential loan defaults, directly impacted by</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="co">#                                             economic conditions and credit risk assessments.</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Deposits Interest Expense (DepIntExp): Cost incurred from interest on deposits, which fluctuates with interest rate </span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="co">#                                        changes.</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Mortgage Banking (MortBank): Income from mortgage-related activities, which can vary significantly with housing market</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co">#                              conditions and interest rates.</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df: Drift Variables</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Debt Securities (DebtSec): Typically more stable investments unless significantly impacted by interest rate changes or </span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co">#       credit quality adjustments.</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Loans Held for Sale (LoansSale): Loans intended for sale in the near term, might not be directly impacted by long-term</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co">#       economic trends.</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Short Term Borrowings Interest Expense (STBIntExp): Costs associated with short-term borrowings, which could have fixed</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="co">#       rates or short adjustment periods.</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Long Term Debt Interest Expense (LTBIntExp): Costs related to long-term borrowings, which may be fixed or less sensitive</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="co">#       to immediate market fluctuations.</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Other Interest Expense (OthIntExp): Miscellaneous interest expenses that may not directly correlate with macroeconomic</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Deposit Lending Related Fees (DepLendFees): Fees associated with deposit accounts and lending services, relatively stable</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="co">#       and less directly impacted by macro conditions.</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Investment Advisory &amp; Other Asset-Based Fees (InvAdvFees): Fees earned from managing client assets, depending on market</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="co">#       conditions but also on contractual arrangements.</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Commissions &amp; Brokerage Services Fees (CommBrkFees): Fees from brokerage and trading services, </span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="co">#       somewhat dependent on market activity levels.</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Investment Banking Fees (InvBankFees): Revenue from investment banking activities, which can fluctuate with </span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co">#       market conditions but are also driven by deal flow.</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Card Fees (CardFees): Fees associated with credit and debit card usage, generally stable unless consumer spending</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="co">#       habits change significantly.</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Net Gains from Trading Securities (NetGainTrade): Profits from trading activities, highly variable but also dependent </span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="co">#       on trading strategies and market conditions.</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Other Noninterest Income (OthNonIntInc): Diverse sources of income not classified elsewhere, potentially variable </span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="co">#       but not directly linked to macroeconomic stressors.</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Personnel (Personnel): Employee-related expenses, relatively fixed in the short term.</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Technology, Telecommunications, and Equipment (TechTelEquip): Expenses related to technology and equipment, </span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co">#       typically follow planned investment patterns.</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Occupancy (Occupancy): Costs associated with physical premises, largely fixed.</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Operating Losses (OperLoss): Losses from operational issues, not directly linked to economic conditions.</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Professional and Outside Services (ProfOutServ): Costs for external services, can vary with business activity </span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="co">#       but not directly tied to economic stressors.</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Advertising and Promotion (AdvPromo): Marketing and advertising costs, generally discretionary.</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Other Noninterest Expense (OthNonIntExp): Miscellaneous expenses not categorized elsewhere</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Income Tax Expense (TaxExp): Taxes on profits, varies with earnings but not directly impacted by most macroeconomic </span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Net Income Loss from Noncontrolling Interests (NetIncLossNCI): Earnings attributed to noncontrolling interests, </span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="co">#       varies based on subsidiary performance.</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Preferred Stock Dividends and Other (PrefStkDiv): Dividends and similar payments to preferred shareholders, </span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co">#       typically fixed based on issuance terms.</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co"># *summary:*</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Variables: 36</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co">#   Calculated Variables: 7</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="co">#   Input Variables: 4</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="co">#   Drift Variables: 36 - 7 - 4 = 25</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="co"># income_df</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Total Variables: 38</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a><span class="co">#   Calculated Variables: 10</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a><span class="co">#   Input Variables: 6</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a><span class="co">#   Drift Variables: 38 - 10 - 6 = 22</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Transpose dataframes</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>balance_df_t <span class="ot">&lt;-</span> <span class="fu">t</span>(balance_df)</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>balance_df_t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(balance_df_t)</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>income_df_t <span class="ot">&lt;-</span> <span class="fu">t</span>(income_df)</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>income_df_t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(income_df_t)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Balance Sheet Dataframe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Balance Sheet Dataframe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(balance_df_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    2022    2023
Cash               34596   33026
IntEarnDep        124561  204193
FedFundsSold       68036   80456
TradDebtSec        86155   97302
AvailSaleDebtSec  113594  130448
HeldMatDebtSec    297059  262708
TotDebtSec        496808  490458
LoansForSale        7104    4936
Loans             955871  936682
LoanLossAllow     -12985  -14606
NetLoans          942886  922076
MortServRights     10480    8508
PremEquip           8350    9266
Goodwill           25173   25175
DerivAssets        22774   18223
EquitySec          64414   57336
OthAssets          75838   78815
NonIntBearDep     458010  360279
IntBearDep        925975  997894
TotDep           1383985 1358173
STBorrow           51145   89559
DerivLiab          20067   18495
AccExpOthLiab      68740   71210
LTDebt            174870  207588
TotLiab          1698807 1745025
PrefStock          19448   19448
ComStock            9136    9136
AddlPaidCap        60319   60555
RetEarn           187968  201136
AOCL              -13362  -11580
TreasStock        -82853  -92960
UnearnESOP          -429       0
NonCtrlInt          1986    1708
TotSHREq          182213  187443
TotAssets        1881020 1932468
TotLiabEq        1881020 1932468</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Income Statement Dataframe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Income Statement Dataframe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(income_df_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               2021  2022  2023
DebtSec        9253 11781 16108
LoansSale       865   513   363
Loans         28634 37715 57155
EqSec           608   707   682
OthIntInc       334  3308 10810
TotIntInc     39694 54024 85118
DepIntExp       388  2349 16503
STBIntExp       -41   582  3848
LTBIntExp      3173  5505 11572
OthIntExp       395   638   820
TotIntExp      3915  9074 32743
NetIntInc     35779 44950 52375
DepLendFees    6920  6713  6140
InvAdvFees    11011  9004  8670
CommBrkFees    2299  2242  2375
InvBankFees    2354  1439  1649
CardFees       4175  4355  4256
MortBank       4956  1383   829
NetGainTrade   7264  1461  4368
OthNonIntInc   4408  2821  1935
TotNonIntInc  43387 29418 30222
TotRev        79166 74368 82597
ProvCredLoss  -4155  1534  5399
Personnel     35541 34340 35829
TechTelEquip   3227  3375  3920
Occupancy      2968  2881  2884
OperLoss       1568  6984  1183
ProfOutServ    5723  5188  5085
AdvPromo        600   505   812
OthNonIntExp   4131  3932  5849
TotNonIntExp  53758 57205 55562
IncBefTax     29563 15629 21636
TaxExp         5764  2251  2607
NetIncBefNCI  23799 13378 19029
NetIncLossNCI  1690  -299  -113
WFNetInc      22109 13677 19142
PrefStkDiv     1291  1115  1160
WFNetIncCS    20818 12562 17982</code></pre>
</div>
</div>
</section>
<section id="second-code-block-simulate-the-go-forward-input-variables-influenced-accounts" class="level2">
<h2 class="anchored" data-anchor-id="second-code-block-simulate-the-go-forward-input-variables-influenced-accounts">Second code block: simulate the go-forward input variables (influenced accounts)</h2>
<ul>
<li>Initialize coefficient matrices with hypothetical values.</li>
<li>Defines stress scenario changes</li>
<li>Calculate changes in the input variables based on the stress scenario.</li>
<li>Update INPUT accounts; i.e., newBalancevalues and newIncomeValues</li>
<li>Updates the balance_df and income_df dataframes; note the other values will be NA at the point.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define names for input and macro variables for clarity</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>balanceInputVarNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Loans"</span>, <span class="st">"LoanLossAllow"</span>, <span class="st">"NonIntBearDep"</span>, <span class="st">"IntBearDep"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>incomeInputVarNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Loans"</span>, <span class="st">"EqSec"</span>, <span class="st">"OthIntInc"</span>, <span class="st">"ProvCredLoss"</span>, <span class="st">"DepIntExp"</span>, <span class="st">"MortBank"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define macro variable names</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>macroVarNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GDP Growth"</span>, <span class="st">"Unemployment Rate"</span>, <span class="st">"Interest Rates"</span>, <span class="st">"Housing Market"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Inflation Rate"</span>, <span class="st">"Stock Market"</span>, <span class="st">"Consumer Confidence"</span>, <span class="st">"Corporate Profits"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the coefficient matrix with hypothetical values</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>balanceCoefficients <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(<span class="dv">32</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">8</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(balanceInputVarNames, macroVarNames))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>incomeCoefficients <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(<span class="dv">48</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">nrow =</span> <span class="dv">6</span>, <span class="at">ncol =</span> <span class="dv">8</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(incomeInputVarNames, macroVarNames))  <span class="co"># 6 income inputs and 8 macro variables</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define stress scenario changes - assuming 1 set of changes for simplicity, which can be expanded</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>stressScenarios <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="sc">-</span><span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="sc">-</span><span class="fl">0.02</span>, <span class="fl">0.03</span>, <span class="fl">0.04</span>, <span class="sc">-</span><span class="fl">0.01</span>), <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(macroVarNames, <span class="st">"Change"</span>))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the last row (2023 values) as the base for simulation</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>balanceInputs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(balance_df[<span class="fu">nrow</span>(balance_df), balanceInputVarNames])</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>incomeInputs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(income_df[<span class="fu">nrow</span>(income_df), incomeInputVarNames])</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate changes for each matrix and transpose</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>balanceChangeMatrix <span class="ot">&lt;-</span> balanceCoefficients <span class="sc">%*%</span> stressScenarios</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>balanceChangeMatrix_t <span class="ot">&lt;-</span> <span class="fu">t</span>(balanceChangeMatrix)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>incomeChangeMatrix <span class="ot">&lt;-</span> incomeCoefficients <span class="sc">%*%</span> stressScenarios</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>incomeChangeMatrix_t <span class="ot">&lt;-</span> <span class="fu">t</span>(incomeChangeMatrix)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply changes to the original values from the last rows of each dataframe</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>newBalanceValues <span class="ot">&lt;-</span> balanceInputs <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> balanceChangeMatrix_t)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>newIncomeValues <span class="ot">&lt;-</span> incomeInputs <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> incomeChangeMatrix_t)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the dataframes with these new values for the next year's projection</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df) <span class="sc">+</span> <span class="dv">1</span>, balanceInputVarNames] <span class="ot">&lt;-</span> <span class="fu">t</span>(newBalanceValues)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df) <span class="sc">+</span> <span class="dv">1</span>, incomeInputVarNames] <span class="ot">&lt;-</span> newIncomeValues</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>format_percent <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, x <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>formatted_balance_coefficients <span class="ot">&lt;-</span> <span class="fu">apply</span>(balanceCoefficients, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), format_percent)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>formatted_balance_coefficients_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(formatted_balance_coefficients)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Balance Coefficient Matrix:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Balance Coefficient Matrix:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(formatted_balance_coefficients_df, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              GDP Growth Unemployment Rate Interest Rates Housing Market
Loans             -3.12%             2.73%          8.24%         -2.89%
LoanLossAllow      7.10%            -9.28%         -2.36%         -1.59%
NonIntBearDep      7.88%            -5.30%         -7.29%          3.29%
IntBearDep        -9.84%             7.36%         -0.43%         -0.62%
              Inflation Rate Stock Market Consumer Confidence Corporate Profits
Loans                 -3.40%        8.59%               4.32%             2.88%
LoanLossAllow          4.27%       -5.65%               7.45%             8.41%
NonIntBearDep          1.58%       -3.15%              -4.44%            -5.69%
IntBearDep            -5.51%        6.25%               4.21%             5.77%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Format and print the income coefficient matrix</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>formatted_income_coefficients <span class="ot">&lt;-</span> <span class="fu">apply</span>(incomeCoefficients, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), format_percent)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>formatted_income_coefficients_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(formatted_income_coefficients)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Income Coefficient Matrix:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Income Coefficient Matrix:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(formatted_income_coefficients_df, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             GDP Growth Unemployment Rate Interest Rates Housing Market
Loans            -5.55%             0.74%         -5.08%         -3.37%
EqSec            -3.55%            -3.00%         -1.78%         -1.02%
OthIntInc         4.33%            -8.75%         -4.83%          1.85%
ProvCredLoss     -7.57%            -6.37%         -4.73%          9.31%
DepIntExp         0.45%             2.24%         -6.16%          5.16%
MortBank         -4.33%            -0.73%         -4.04%          3.63%
             Inflation Rate Stock Market Consumer Confidence Corporate Profits
Loans                 2.17%       -1.18%               7.28%            -5.28%
EqSec                 9.44%        8.05%              -7.32%             0.57%
OthIntInc             1.43%        5.21%              -7.94%             8.02%
ProvCredLoss         -1.87%       -6.92%              -3.75%             7.53%
DepIntExp            -8.28%        1.09%              -2.73%             9.04%
MortBank             -1.33%        4.78%               9.79%             6.42%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Stress Scenario Changes:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Stress Scenario Changes:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stressScenarios)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Change
GDP Growth           -0.01
Unemployment Rate     0.02
Interest Rates       -0.03
Housing Market        0.01
Inflation Rate       -0.02
Stock Market          0.03
Consumer Confidence   0.04
Corporate Profits    -0.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Balance Change Matrix:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Balance Change Matrix:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">as.data.frame</span>(<span class="fu">apply</span>(balanceChangeMatrix_t, <span class="dv">2</span>, format_percent)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              apply(balanceChangeMatrix_t, 2, format_percent)
Loans                                                   0.28%
LoanLossAllow                                          -0.24%
NonIntBearDep                                          -0.18%
IntBearDep                                              0.66%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Income Change Matrix:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Income Change Matrix:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">as.data.frame</span>(<span class="fu">apply</span>(incomeChangeMatrix_t, <span class="dv">2</span>, format_percent)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             apply(incomeChangeMatrix_t, 2, format_percent)
Loans                                                 0.45%
EqSec                                                -0.23%
OthIntInc                                            -0.33%
ProvCredLoss                                         -0.21%
DepIntExp                                             0.28%
MortBank                                              0.68%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's just confirm with Loans</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>loans_coefficients <span class="ot">&lt;-</span> balanceCoefficients[<span class="st">"Loans"</span>, ]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>stress_scenario_values <span class="ot">&lt;-</span> stressScenarios[, <span class="st">"Change"</span>]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>intermediate_results_loans <span class="ot">&lt;-</span> loans_coefficients <span class="sc">*</span> stress_scenario_values</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>total_change_loans <span class="ot">&lt;-</span> <span class="fu">sum</span>(intermediate_results_loans)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>total_change_loans_percentage <span class="ot">&lt;-</span> total_change_loans <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Total Change for Balance Sheet Loans (as percentage):"</span>, <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, total_change_loans_percentage)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Total Change for Balance Sheet Loans (as percentage): 0.28%"</code></pre>
</div>
</div>
</section>
<section id="third-code-block-apply-drift-rates-to-the-drift-variables" class="level2">
<h2 class="anchored" data-anchor-id="third-code-block-apply-drift-rates-to-the-drift-variables">Third code block: apply drift rates to the drift variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example drift rates for demonstration</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>balanceCalcVarNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"TotDebtSec"</span>, <span class="st">"NetLoans"</span>, <span class="st">"TotDep"</span>, <span class="st">"TotLiab"</span>, <span class="st">"TotSHREq"</span>, <span class="st">"TotAssets"</span>, <span class="st">"TotLiabEq"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>incomeCalcVarNames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"TotIntInc"</span>, <span class="st">"TotIntExp"</span>, <span class="st">"NetIntInc"</span>, <span class="st">"TotNonIntInc"</span>, <span class="st">"TotRev"</span>, </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"TotNonIntExp"</span>, <span class="st">"IncBefTax"</span>,<span class="st">"NetIncBefNCI"</span>, <span class="st">"WFNetInc"</span>, <span class="st">"WFNetIncCS"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define indices or names for drift variables and their rates</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>driftVarIndicesBalance <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(balance_df), <span class="fu">c</span>(balanceCalcVarNames, balanceInputVarNames))</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>driftVarIndicesIncome <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(income_df), <span class="fu">c</span>(incomeCalcVarNames, incomeInputVarNames))</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Example drift rates for demonstration</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># vector of repeating value the length of driftVarIndicesBalance</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>driftRatesBalance <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.02</span>, <span class="fu">length</span>(driftVarIndicesBalance))</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>driftRatesIncome <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.03</span>, <span class="fu">length</span>(driftVarIndicesIncome))</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply drift</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), driftVarIndicesBalance] <span class="ot">&lt;-</span> balance_df[<span class="fu">nrow</span>(balance_df) <span class="sc">-</span> <span class="dv">1</span>, driftVarIndicesBalance] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> driftRatesBalance)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), driftVarIndicesIncome] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df) <span class="sc">-</span> <span class="dv">1</span>, driftVarIndicesIncome] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> driftRatesIncome)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the drift variables and their new values for balance_df</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Balance Drift Variables and Their New Values:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Balance Drift Variables and Their New Values:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> driftVarIndicesBalance) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%s: %.2f -&gt; %.2f</span><span class="sc">\n</span><span class="st">"</span>, var, balance_df[<span class="fu">nrow</span>(balance_df) <span class="sc">-</span> <span class="dv">1</span>, var], balance_df[<span class="fu">nrow</span>(balance_df), var]))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cash: 33026.00 -&gt; 33686.52
IntEarnDep: 204193.00 -&gt; 208276.86
FedFundsSold: 80456.00 -&gt; 82065.12
TradDebtSec: 97302.00 -&gt; 99248.04
AvailSaleDebtSec: 130448.00 -&gt; 133056.96
HeldMatDebtSec: 262708.00 -&gt; 267962.16
LoansForSale: 4936.00 -&gt; 5034.72
MortServRights: 8508.00 -&gt; 8678.16
PremEquip: 9266.00 -&gt; 9451.32
Goodwill: 25175.00 -&gt; 25678.50
DerivAssets: 18223.00 -&gt; 18587.46
EquitySec: 57336.00 -&gt; 58482.72
OthAssets: 78815.00 -&gt; 80391.30
STBorrow: 89559.00 -&gt; 91350.18
DerivLiab: 18495.00 -&gt; 18864.90
AccExpOthLiab: 71210.00 -&gt; 72634.20
LTDebt: 207588.00 -&gt; 211739.76
PrefStock: 19448.00 -&gt; 19836.96
ComStock: 9136.00 -&gt; 9318.72
AddlPaidCap: 60555.00 -&gt; 61766.10
RetEarn: 201136.00 -&gt; 205158.72
AOCL: -11580.00 -&gt; -11811.60
TreasStock: -92960.00 -&gt; -94819.20
UnearnESOP: 0.00 -&gt; 0.00
NonCtrlInt: 1708.00 -&gt; 1742.16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the drift variables and their new values for income_df</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Income Drift Variables and Their New Values:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Income Drift Variables and Their New Values:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> driftVarIndicesIncome) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%s: %.2f -&gt; %.2f</span><span class="sc">\n</span><span class="st">"</span>, var, income_df[<span class="fu">nrow</span>(income_df) <span class="sc">-</span> <span class="dv">1</span>, var], income_df[<span class="fu">nrow</span>(income_df), var]))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DebtSec: 16108.00 -&gt; 16591.24
LoansSale: 363.00 -&gt; 373.89
STBIntExp: 3848.00 -&gt; 3963.44
LTBIntExp: 11572.00 -&gt; 11919.16
OthIntExp: 820.00 -&gt; 844.60
DepLendFees: 6140.00 -&gt; 6324.20
InvAdvFees: 8670.00 -&gt; 8930.10
CommBrkFees: 2375.00 -&gt; 2446.25
InvBankFees: 1649.00 -&gt; 1698.47
CardFees: 4256.00 -&gt; 4383.68
NetGainTrade: 4368.00 -&gt; 4499.04
OthNonIntInc: 1935.00 -&gt; 1993.05
Personnel: 35829.00 -&gt; 36903.87
TechTelEquip: 3920.00 -&gt; 4037.60
Occupancy: 2884.00 -&gt; 2970.52
OperLoss: 1183.00 -&gt; 1218.49
ProfOutServ: 5085.00 -&gt; 5237.55
AdvPromo: 812.00 -&gt; 836.36
OthNonIntExp: 5849.00 -&gt; 6024.47
TaxExp: 2607.00 -&gt; 2685.21
NetIncLossNCI: -113.00 -&gt; -116.39
PrefStkDiv: 1160.00 -&gt; 1194.80</code></pre>
</div>
</div>
</section>
<section id="fourth-code-block-update-calculated-variables" class="level2">
<h2 class="anchored" data-anchor-id="fourth-code-block-update-calculated-variables">Fourth code block: update calculated variables</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update calculated variables directly in the latest row</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotDebtSec"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"TradDebtSec"</span>, <span class="st">"AvailSaleDebtSec"</span>, <span class="st">"HeldMatDebtSec"</span>)])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"NetLoans"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"Loans"</span>, <span class="st">"LoanLossAllow"</span>)])</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotAssets"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"Cash"</span>, <span class="st">"IntEarnDep"</span>, <span class="st">"FedFundsSold"</span>, <span class="st">"TotDebtSec"</span>, <span class="st">"LoansForSale"</span>, <span class="st">"NetLoans"</span>, <span class="st">"MortServRights"</span>, <span class="st">"PremEquip"</span>, <span class="st">"Goodwill"</span>, <span class="st">"DerivAssets"</span>, <span class="st">"EquitySec"</span>, <span class="st">"OthAssets"</span>)])</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotDep"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"NonIntBearDep"</span>, <span class="st">"IntBearDep"</span>)])</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotLiab"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"TotDep"</span>, <span class="st">"STBorrow"</span>, <span class="st">"DerivLiab"</span>, <span class="st">"AccExpOthLiab"</span>, <span class="st">"LTDebt"</span>)])</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># balance_df[nrow(balance_df), "TotSHREq"] &lt;- sum(balance_df[nrow(balance_df), c("PrefStock", "ComStock", "AddlPaidCap",     #       "RetEarn", "AOCL", "TreasStock", "UnearnESOP", "NonCtrlInt")])</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotSHREq"</span>] <span class="ot">&lt;-</span> balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotAssets"</span>] <span class="sc">-</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotLiab"</span>] </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>balance_df[<span class="fu">nrow</span>(balance_df), <span class="st">"TotLiabEq"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(balance_df[<span class="fu">nrow</span>(balance_df), <span class="fu">c</span>(<span class="st">"TotLiab"</span>, <span class="st">"TotSHREq"</span>)])</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Update calculated variables directly in the latest row</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotIntInc"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(income_df[<span class="fu">nrow</span>(income_df), <span class="fu">c</span>(<span class="st">"DebtSec"</span>, <span class="st">"LoansSale"</span>, <span class="st">"Loans"</span>, <span class="st">"EqSec"</span>, <span class="st">"OthIntInc"</span>)])</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotIntExp"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(income_df[<span class="fu">nrow</span>(income_df), <span class="fu">c</span>(<span class="st">"DepIntExp"</span>, <span class="st">"STBIntExp"</span>, <span class="st">"LTBIntExp"</span>, <span class="st">"OthIntExp"</span>)])</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"NetIntInc"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotIntInc"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotIntExp"</span>]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotNonIntInc"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(income_df[<span class="fu">nrow</span>(income_df), <span class="fu">c</span>(<span class="st">"DepLendFees"</span>, <span class="st">"InvAdvFees"</span>, <span class="st">"CommBrkFees"</span>, <span class="st">"InvBankFees"</span>, <span class="st">"CardFees"</span>, <span class="st">"MortBank"</span>, <span class="st">"NetGainTrade"</span>, <span class="st">"OthNonIntInc"</span>)])</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotRev"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"NetIntInc"</span>] <span class="sc">+</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotNonIntInc"</span>]</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotNonIntExp"</span>] <span class="ot">&lt;-</span> <span class="fu">sum</span>(income_df[<span class="fu">nrow</span>(income_df), <span class="fu">c</span>(<span class="st">"Personnel"</span>, <span class="st">"TechTelEquip"</span>, <span class="st">"Occupancy"</span>, <span class="st">"OperLoss"</span>, <span class="st">"ProfOutServ"</span>, <span class="st">"AdvPromo"</span>, <span class="st">"OthNonIntExp"</span>)])</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"IncBefTax"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotRev"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TotNonIntExp"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"ProvCredLoss"</span>]</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"NetIncBefNCI"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"IncBefTax"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"TaxExp"</span>]</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"WFNetInc"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"NetIncBefNCI"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"NetIncLossNCI"</span>]</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>income_df[<span class="fu">nrow</span>(income_df), <span class="st">"WFNetIncCS"</span>] <span class="ot">&lt;-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"WFNetInc"</span>] <span class="sc">-</span> income_df[<span class="fu">nrow</span>(income_df), <span class="st">"PrefStkDiv"</span>]</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(balance_df)[<span class="fu">nrow</span>(balance_df)] <span class="ot">&lt;-</span> <span class="st">"2024"</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(income_df)[<span class="fu">nrow</span>(income_df)] <span class="ot">&lt;-</span> <span class="st">"2024"</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the updated dataframes</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>balance_df_t <span class="ot">&lt;-</span> <span class="fu">t</span>(balance_df)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>balance_df_t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(balance_df_t)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>income_df_t <span class="ot">&lt;-</span> <span class="fu">t</span>(income_df)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>income_df_t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(income_df_t)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Balance Sheet Dataframe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Balance Sheet Dataframe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(balance_df_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    2022    2023       2024
Cash               34596   33026   33686.52
IntEarnDep        124561  204193  208276.86
FedFundsSold       68036   80456   82065.12
TradDebtSec        86155   97302   99248.04
AvailSaleDebtSec  113594  130448  133056.96
HeldMatDebtSec    297059  262708  267962.16
TotDebtSec        496808  490458  500267.16
LoansForSale        7104    4936    5034.72
Loans             955871  936682  939299.44
LoanLossAllow     -12985  -14606  -14570.53
NetLoans          942886  922076  924728.91
MortServRights     10480    8508    8678.16
PremEquip           8350    9266    9451.32
Goodwill           25173   25175   25678.50
DerivAssets        22774   18223   18587.46
EquitySec          64414   57336   58482.72
OthAssets          75838   78815   80391.30
NonIntBearDep     458010  360279  359630.90
IntBearDep        925975  997894 1004485.92
TotDep           1383985 1358173 1364116.83
STBorrow           51145   89559   91350.18
DerivLiab          20067   18495   18864.90
AccExpOthLiab      68740   71210   72634.20
LTDebt            174870  207588  211739.76
TotLiab          1698807 1745025 1758705.87
PrefStock          19448   19448   19836.96
ComStock            9136    9136    9318.72
AddlPaidCap        60319   60555   61766.10
RetEarn           187968  201136  205158.72
AOCL              -13362  -11580  -11811.60
TreasStock        -82853  -92960  -94819.20
UnearnESOP          -429       0       0.00
NonCtrlInt          1986    1708    1742.16
TotSHREq          182213  187443  196622.88
TotAssets        1881020 1932468 1955328.75
TotLiabEq        1881020 1932468 1955328.75</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Income Statement Dataframe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Income Statement Dataframe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(income_df_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               2021  2022  2023       2024
DebtSec        9253 11781 16108 16591.2400
LoansSale       865   513   363   373.8900
Loans         28634 37715 57155 57414.4138
EqSec           608   707   682   680.4498
OthIntInc       334  3308 10810 10774.8639
TotIntInc     39694 54024 85118 85834.8574
DepIntExp       388  2349 16503 16548.3975
STBIntExp       -41   582  3848  3963.4400
LTBIntExp      3173  5505 11572 11919.1600
OthIntExp       395   638   820   844.6000
TotIntExp      3915  9074 32743 33275.5975
NetIntInc     35779 44950 52375 52559.2599
DepLendFees    6920  6713  6140  6324.2000
InvAdvFees    11011  9004  8670  8930.1000
CommBrkFees    2299  2242  2375  2446.2500
InvBankFees    2354  1439  1649  1698.4700
CardFees       4175  4355  4256  4383.6800
MortBank       4956  1383   829   834.6686
NetGainTrade   7264  1461  4368  4499.0400
OthNonIntInc   4408  2821  1935  1993.0500
TotNonIntInc  43387 29418 30222 31109.4586
TotRev        79166 74368 82597 83668.7186
ProvCredLoss  -4155  1534  5399  5387.5345
Personnel     35541 34340 35829 36903.8700
TechTelEquip   3227  3375  3920  4037.6000
Occupancy      2968  2881  2884  2970.5200
OperLoss       1568  6984  1183  1218.4900
ProfOutServ    5723  5188  5085  5237.5500
AdvPromo        600   505   812   836.3600
OthNonIntExp   4131  3932  5849  6024.4700
TotNonIntExp  53758 57205 55562 57228.8600
IncBefTax     29563 15629 21636 21052.3240
TaxExp         5764  2251  2607  2685.2100
NetIncBefNCI  23799 13378 19029 18367.1140
NetIncLossNCI  1690  -299  -113  -116.3900
WFNetInc      22109 13677 19142 18483.5040
PrefStkDiv     1291  1115  1160  1194.8000
WFNetIncCS    20818 12562 17982 17288.7040</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>